# 작업 로그 - 2026-02-05

## 완료 항목

### 1. Phase 8: 알림(Notification) 시스템 완성

이전 세션에서 Step 1~5 완료, 이번 세션에서 Step 6~7 완료.

#### 1.1 알림 트리거 추가 (Step 6)

| 트리거 | 파일 | 타입 | 수신자 |
|--------|------|------|--------|
| 댓글 알림 | `bbs/write_comment_update.php` | `comment` | 원글 작성자 |
| 답글 알림 | `bbs/write_comment_update.php` | `reply` | 부모 댓글 작성자 |
| 추천 알림 | `bbs/good.php` | `like` | 글 작성자 (추천만, 비추천 제외) |
| RP 이음 알림 | `bbs/rp_reply.php` | `rp_reply` | 역극 생성자 (캐릭터명으로 표시) |

- 모든 트리거에 자기 자신 제외 로직 (`$mb_id !== $member['mb_id']`)
- `function_exists('mg_notify')` 안전 체크 포함
- `good.php`는 JS/HTML 분기 양쪽 모두 처리

#### 1.2 기존 알림 트리거 (이전 세션에서 완료)

| 트리거 | 타입 |
|--------|------|
| 캐릭터 승인/반려/미승인/삭제 | `character_approved` / `character_rejected` 등 |
| 선물 수신/수락/거절 | `gift_received` / `gift_accepted` / `gift_rejected` |
| 이모티콘 셋 승인/반려 | `emoticon` |

#### 1.3 Tailwind CSS 리빌드 (Step 7)

---

### 2. 토스트 알림 구현

#### 2.1 동작 방식
```
30초 폴링 → 미읽은 카운트 증가 감지
          → 최신 미읽은 알림 1개 조회 (notification_api.php?action=list&rows=1&unread_only=1)
          → 화면 우하단에 토스트 표시
```

#### 2.2 토스트 UI 사양
- 위치: 화면 우하단 (fixed, bottom-right)
- 애니메이션: 오른쪽에서 슬라이드 인 → 5초 후 자동 퇴장
- X 버튼으로 즉시 닫기 가능
- 토스트 클릭 시 읽음 처리 + 해당 URL로 이동
- 여러 알림 동시 발생 시 아래에서 위로 쌓임
- 테마 CSS 변수 사용 (`--mg-bg-secondary`, `--mg-text-primary` 등)

#### 2.3 수정 파일
- `theme/morgan/js/notification.js`
  - `createToastContainer()` - 토스트 컨테이너 DOM 생성
  - `fetchLatestForToast()` - 최신 알림 1개 조회
  - `showToast(item)` - 토스트 렌더링 + 애니메이션 + 자동 퇴장
  - `fetchCount()` 수정 - 카운트 증가 시 `fetchLatestForToast()` 호출

---

### 3. 역극 완결 버그 수정

#### 3.1 문제
- `theme/morgan/skin/rp/view.skin.php`에 판장용 "완결" 버튼이 `rp_close.php`를 호출
- `bbs/rp_close.php` 파일이 존재하지 않아 404 에러 발생
- 판장이 자기 역극을 완결할 수 없는 상태였음

#### 3.2 해결
- `bbs/rp_close.php` 신규 생성

#### 3.3 완결 처리 로직
- 판장(역극 생성자) 또는 최고관리자만 완결 가능
- 이미 완결된 역극은 중복 처리 방지
- 관리자가 대신 완결한 경우 판장에게 `system` 타입 알림 발송
- 완결 후 역극 보기 페이지로 리다이렉트
- `rt_status = 'closed'` → 향후 vn_engine 컨버팅 대상 필터 기준

---

## 수정 파일 목록

| 파일 | 작업 |
|------|------|
| `bbs/write_comment_update.php` | 댓글/답글 알림 트리거 추가 |
| `bbs/good.php` | 추천 알림 트리거 추가 (JS/HTML 양쪽) |
| `bbs/rp_reply.php` | RP 이음 알림 트리거 추가 |
| `bbs/rp_close.php` | **신규** - 역극 완결 처리 |
| `theme/morgan/js/notification.js` | 토스트 알림 기능 추가 |
| `theme/morgan/css/style.css` | Tailwind 리빌드 |

---

## 알림 시스템 전체 구성 (Phase 8 최종)

```
[백엔드]
plugin/morgan/morgan.php        - mg_notify(), 헬퍼 함수 5개
bbs/notification_api.php         - AJAX API (count/list/read/read_all/delete/delete_read)
bbs/notification.php             - 알림 목록 페이지

[프론트엔드]
theme/morgan/head.php            - 벨 아이콘 + 드롭다운 패널
theme/morgan/js/notification.js  - 폴링, 드롭다운, 토스트
theme/morgan/skin/notification/  - 목록 페이지 스킨

[관리자]
adm/morgan/notification.php      - 알림 관리
adm/morgan/notification_update.php - 알림 일괄 처리

[트리거 위치]
bbs/write_comment_update.php     - 댓글/답글
bbs/good.php                     - 추천
bbs/rp_reply.php                 - RP 이음
plugin/morgan/morgan.php         - 캐릭터, 선물, 이모티콘
```

---

## 다음 작업 예정

- 전체 디버깅 (사용자 확인 후)
- ROADMAP.md 업데이트 (Phase 6~8 완료 반영)
- Phase 9: 파이오니어 시스템 또는 업적 시스템 (`docs/PLAN_PIONEER.md`, `docs/PLAN_ACHIEVEMENT.md`)

---

## 참고

- 토스트 알림은 폴링 기반 (30초 간격), 실시간(Supabase 등)은 채팅/동시 RP 등 필요 시 도입 예정
- 역극 완결(`rt_status = 'closed'`)은 향후 vn_engine 컨버팅 필터 기준으로 활용 예정
- 알림 서버 부하: COUNT 쿼리 30초 1회, 동접 100명 기준 초당 3~4회 수준 (무시 가능)

---

*작성일: 2026-02-05*
