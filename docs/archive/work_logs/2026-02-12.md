# 작업 로그 - 2026-02-12

## 완료 항목

### 1. 상점 모바일 반응형 수정

- **원인**: `#main-content`(`flex-1`)에 `min-w-0` 미적용 → 자식 테이블의 `min-width:480px`가 flex item을 확장
- **수정**: `theme/morgan/head.php` — `#main-content`에 `min-w-0` 클래스 추가
- Playwright 검증: shop, gift, inventory 3페이지 모바일(375px) 수평 스크롤 없음

### 2. 개척 노동력 투입 오류 수정

- **원인**: `sql_affected_rows()` 함수가 Gnuboard에 존재하지 않음 → PHP Fatal Error
- **수정**: `plugin/morgan/morgan.php`에 `sql_affected_rows()` 래퍼 함수 추가 (`mysqli_affected_rows($GLOBALS['connect_db'])`)
- 영향 범위: morgan.php 내 4곳 (line 727, 2982, 3044, 3127)

### 3. ROADMAP 업데이트

- Phase 15 (Lore Wiki) 완료 반영
- Phase 16 (Prompt Mission) 완료 반영, 섹션 번호 수정
- Phase 18 댓글 주사위 추가
- Phase 19 탐색 파견 추가
- Research Tree → Phase 20, SS Engine → Phase 21로 재번호

### 4. Phase 17: 캐릭터 관계 시스템 (백엔드 + 관리자 완료)

#### 4.1 DB + 테이블 등록
- `mg_relation_icon` 테이블 (아이콘 정의: 카테고리, 이모지, 라벨, 색상, 굵기)
- `mg_relation` 테이블 (관계 데이터: 양방향 라벨/메모/아이콘, 정규화 ch_id_a < ch_id_b)
- 기본 아이콘 9종 시드 (love×2, friendship×2, family, rival, mentor, etc×2)
- `install.sql`, `morgan.php` 테이블 등록 ($g5, $mg)

#### 4.2 핵심 함수 12개 (plugin/morgan/morgan.php)
- `mg_get_relation_icons()` — 아이콘 목록
- `mg_get_relation_icon()` — 아이콘 단건
- `mg_get_relation()` — 관계 단건 (JOIN icon+character)
- `mg_get_relations()` — 캐릭터 관계 목록
- `mg_get_relation_by_pair()` — 쌍 조회
- `mg_request_relation()` — 관계 신청 (정규화 + INSERT + 알림)
- `mg_accept_relation()` — 승인 (UPDATE + 알림)
- `mg_reject_relation()` — 거절 (DELETE + 알림)
- `mg_delete_relation()` — 해제 (DELETE + 알림)
- `mg_update_relation_side()` — 자기쪽 수정
- `mg_get_relation_graph()` — vis.js nodes+edges (BFS depth 탐색)
- `mg_get_pending_relations()` — 받은 대기 신청 목록

#### 4.3 프론트 (임시 — UI 재배치 예정)
- `bbs/relation.php` — 관계 관리 페이지 (3탭: 내 관계/받은 신청/보낸 신청)
- `bbs/relation_api.php` — AJAX 엔드포인트 (request/accept/reject/delete/update/search)
- `theme/morgan/skin/relation/relation.skin.php` — 스킨 (3모달: 신청/승인/수정)
- `bbs/relation_graph.php` — vis.js 관계도 페이지
- `bbs/relation_graph_api.php` — 그래프 데이터 JSON API
- `bbs/character_view.php` — 관계 섹션 추가 (인장 위)
- `theme/morgan/head.php` — 사이드바 관계도 아이콘 + 페이지 감지

#### 4.4 관리자
- `adm/morgan/relation_icon.php` — 아이콘 CRUD (추가/수정/삭제/비활성화)
- `adm/morgan/relation.php` — 관계 관리 (필터/검색/강제 승인/삭제/통계)
- `adm/admin.menu800.php` — 메뉴 추가 (801600 관계 아이콘, 801700 관계 관리)

#### 4.5 검증
- PHP syntax: 전체 파일 통과
- Playwright: 관계 신청(test→test2) → 승인 → 그래프 렌더링 → 해제 플로우 통과

---

## 다음 작업 (Phase 17 UI 재배치)

사용자 피드백: 관계는 **캐릭터의 서브 콘텐츠**이지 독립 메뉴가 아님.

| 변경 | 내용 |
|------|------|
| 관계 신청 | `character_view.php`에 버튼 (타인 캐릭터일 때) |
| 관계 관리 | 캐릭터 관리 페이지에 "관계" 탭 (받은 신청/내 관계/보낸 신청) |
| 관계도 | `character_view.php` 내 인라인 vis.js (해당 캐릭터 중심) |
| 제거 | `relation.php` 독립 페이지, `relation_graph.php` 독립 페이지, 사이드바 관계도 아이콘 |

---

## 버그 수정 사항

| 파일 | 수정 |
|------|------|
| `adm/morgan/relation_icon.php` | `G5_ADMIN_PATH.'/_head.php'` → `'./_head.php'` (상대경로) |
| `adm/morgan/relation.php` | 동일 |
