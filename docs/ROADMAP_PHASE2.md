# Morgan Edition - 2차 로드맵

> 작성일: 2026-02-23
> 최종 업데이트: 2026-02-23
> 1차 로드맵: [`docs/ROADMAP.md`](ROADMAP.md)

---

## 개요

1차 Phase(1~18) + 검수 + 잔여 구현(M1~M8)이 완료된 후 진행할 대형 시스템들.
각 모듈은 독립적으로 개발 가능하며, 의존관계가 있는 경우 아래 표에 명시.

**범례**
- [x] 완료
- [-] 부분 구현
- [ ] 미구현

---

## 모듈 요약

| ID | 모듈 | 한줄 요약 | 기획서 | 예상 규모 | 의존성 |
|----|------|----------|--------|-----------|--------|
| A | 연구 트리 | 재화 공동 투입 → 커뮤니티 버프 | `plans/RESEARCH_TREE.md` | 중 | 개척(Pioneer) |
| B | SS Engine | 세미 턴제 RPG + 던전 탐사 | `plans/SS_ENGINE_DESIGN.md` | 특대 | Supabase, 캐릭터, 상점 |
| C | 진영 컨텐츠 | 익명망 + 카드배틀 + 점령전 | `plans/FACTION.md` | 대 | 소속(Side) 시스템 |
| D | 마이룸 | 아이소메트릭 2D 방 꾸미기 | `MODULES.md` | 중 | 상점(가구) |
| E | VN Engine | 역극 → 비주얼 노벨 자동 변환 | `plans/VN_ENGINE.md` | 중 | 역극(RP) |
| F | SRPG | 그리드 기반 Co-op PvE 택틱스 | `plans/morgan_srpg_system_plan.md` | 특대 | Supabase, 캐릭터 |

### 참고: B(SS Engine)와 F(SRPG)의 관계

두 시스템은 기술 인프라(PHP 로직 + Supabase Realtime + 파티 시스템)의 80%가 겹침.
현재는 **별도 시스템으로 병행 유지**하되, 구현 시점에서 공통 인프라(파티 로비, Supabase 채널, 보상 연동)를 공유 모듈로 추출하는 것을 권장.

| 비교 항목 | SS Engine (B) | SRPG (F) |
|----------|---------------|----------|
| 전투 방식 | VN 스타일 UI, 어그로 기반 | 15x15 그리드 택틱스, 이동/범위 |
| 탐사 | 던전 노드맵 (아이작 스타일) | 없음 (보스 레이드 전용) |
| 스탯 | 4종 (체력/근력/마력/숙련) | 8종 (HP/MP/ATK/DEF/MAG/RES/SPD/MOV) |
| 성장 | 창작활동 → 포인트 → 스탯 구매 | 레벨 테이블 또는 포인트 분배 |
| 파티 규모 | 4인 | 2~5인 |
| 보스 AI | 행동 풀 + HP 조건 분기 | 페이즈별 행동 풀 + 가중치 + 전조 |

---

## 2차-A: 연구 트리 (Research Tree)

> 재화 공동 투입으로 커뮤니티 영구 버프 + 시설 해금 전제조건.
> 상세: `plans/RESEARCH_TREE.md`

### A.1 인벤토리 슬롯 제한
- [ ] 재료 종류 슬롯 한도 도입 (기본 8종)
- [ ] 슬롯 초과 시 획득 차단 로직
- [ ] 인벤토리 UI 수정 (슬롯 표시)
- [ ] 관리자 기본/최대 슬롯 설정

### A.2 연구 CRUD
- [ ] DB 테이블 (mg_research, mg_research_require, mg_research_reward, mg_research_contrib)
- [ ] 관리자 연구 등록/수정/삭제
- [ ] 선행 조건 설정 (복수 AND 조건)
- [ ] 보상 타입 설정 (슬롯 확장, 효율 버프, 해금)

### A.3 연구 투입/완료
- [ ] 재화 투입 AJAX 처리
- [ ] 완료 시 보상 적용 (전역 설정값 변경)
- [ ] 선행 조건 자동 해금 체크
- [ ] 기여 랭킹 산출 + 명예의 전당 연동

### A.4 연구 트리 UI
- [ ] 티어별 트리 시각화 페이지
- [ ] 연구 상세 + 투입 UI + 진행률 바
- [ ] 개척 메인에서 "연구소" 탭 추가
- [ ] 인벤토리 글로벌 리소스 바에 슬롯 표시

---

## 2차-B: SS Engine (세미 턴제 RPG)

> 자체 설계 세미 턴제 전투 + 던전 탐사 시스템. Supabase Realtime 연동.
> 상세: `plans/SS_ENGINE_DESIGN.md`

### B.0 DB 구조 재설계 (사전 작업)
- [ ] 기존 TRPG 테이블 폐기 (mg_trpg_ruleset, mg_trpg_stat_field, mg_character_stat_value, mg_character_ruleset)
- [ ] SS Engine 전투 스탯 테이블 설계 (캐릭터별 체력/근력/마력/숙련)
- [ ] 장비 테이블 설계 (무기/방어구, 보정 스탯, 역할별 카테고리)
- [ ] 스킬 테이블 설계 (역할별 기본 스킬 + 상점 스킬, 쿨타임/계수/대상)
- [ ] 몬스터 테이블 설계 (HP/공격력/방어력, 행동 풀, HP 조건 분기)
- [ ] 던전/이벤트 테이블 설계 (노드 맵, 이벤트 라이브러리, 인스턴스)
- [ ] plans/DB.md 스키마 문서 갱신
- [ ] install.sql 반영

### B.1 코어 전투 시스템
- [ ] 스탯 데이터 구조 (체력/근력/마력/숙련)
- [ ] 장비 시스템 (무기+방어구 2슬롯, 보정 스탯)
- [ ] 턴 진행 로직 (유저 턴 3분 → 몬스터 턴 → 턴 전환)
- [ ] 100다이스 판정 (대실패/실패/성공/대성공)
- [ ] 어그로 시스템 (임계치 80, 주시, 자연 감소)
- [ ] 스킬 시스템 (쿨타임 기반, 기본 3슬롯, MP 없음)
- [ ] 역할별 기본 스킬 세트 (탱커/딜러/힐러 각 3~4개)
- [ ] Supabase 연동 (실시간 상태 동기화)

### B.2 몬스터 & 전투 UI
- [ ] 몬스터 등록/관리 (HP/공격력/방어력)
- [ ] 몬스터 행동 풀 (단일공격/전체공격/버프/디버프/특수)
- [ ] 랜덤 패턴 + HP 조건 분기 (연출 대사 + 예고)
- [ ] 전투 UI (VN 스타일 + 행동 선택 + 로그 + 주시 표시)
- [ ] 전투 로그 자동 저장 → 게시판 아카이빙

### B.3 던전 시스템
- [ ] 이벤트 라이브러리 (관리자 등록, 기본 20~30개 제공)
- [ ] 이벤트 판정 (스탯별 100다이스, 4단계 결과)
- [ ] 던전 생성기 (노드 기반 맵, 비율 설정 → 랜덤 생성 → 확정)
- [ ] 미니맵 시각화 (아이작 스타일, 시야 탐색)
- [ ] 방향 선택 + 다수결 로직 (3분 제한, 캐입 채팅 상의)
- [ ] 노드 종류 (일반전투/보스/이벤트/세이브/탈출)
- [ ] 임시 소지 시스템 (세이브/탈출로 확정, 전멸 시 소실)
- [ ] 파티 모집 로비 + 로비 채팅
- [ ] HP 0 / 전멸 / 중간 이탈 처리

### B.4 보상 연동
- [ ] 일반 재료 / 특수 재료(보스 전용) 드랍 테이블
- [ ] 인벤토리 슬롯 제한 + 확장 연동
- [ ] 장비/스킬 상점 연동
- [ ] 파견 시스템과 재료 풀 통합
- [ ] 전투 참여 소량 포인트 보상

### B.5 확장
- [ ] 운영자 커스텀 스킬 에디터
- [ ] 턴별 스크립트 몬스터 (레이드급)
- [ ] 커스텀 맵 에디터
- [ ] 악세서리 슬롯 추가
- [ ] 스킬 슬롯 확장 (연구/상점 연동)

---

## 2차-C: 진영 컨텐츠 (익명망 + 카드배틀 + 점령전)

> 상세 기획: `docs/plans/FACTION.md`

### C.1 익명망
- [x] 기획서 작성 (`docs/plans/FACTION.md`)
- [ ] 시즌 시스템 (mg_faction_season — 익명망+점령전+해킹 통합)
- [ ] 코드네임 시스템 (진영별 접두어 + 번호, 시즌마다 리셋)
- [ ] 진영별 게시판 분리 + 접근 제어
- [ ] NPC 운영 (관리자 코드네임 활동)

### C.2 카드 배틀
- [ ] 카드 등록/관리 (3타입 상성: 공격>회복>방어>공격)
- [ ] 카드 뽑기 (포인트 소모, 중복 시 포인트 환급)
- [ ] 덱 구성 (캐릭터별 공격덱/방어덱 각 5장)
- [ ] 오토배틀 판정 (5라운드, 3승 기준)
- [ ] 일일 전투 횟수 제한 (회원 단위, 기본 5회)

### C.3 점령전
- [ ] 맵/지역 관리 (본진·점령지·미점령지)
- [ ] 점령도 누적 (공격 승리 > 방어 승리)
- [ ] 전투 스케줄 (관리자 설정, 이벤트 개념)
- [ ] 시즌 종료 → 영토 확정 + 보상
- [ ] 승리 진영 다음 전장 투표

### C.4 해킹 / 정보전
- [ ] 해킹 아이템 (개인 구매 → 진영 진척도 누적)
- [ ] 방어 아이템 (해킹보다 비쌈)
- [ ] 해킹 성공 시 30분 타 진영 익명망 접근 (진영 단위)

### C.5 날씨 / 밸런싱
- [ ] 날씨 타입 + 진영별 버프 매핑
- [ ] 소수 진영 보정 (세계관 포장)
- [ ] 날씨 위젯

---

## 2차-D: 마이룸 시스템

> 아이소메트릭 2D 방 꾸미기. 상점 가구 아이템 연동.
> 상세: `docs/MODULES.md`

### D.1 마이룸 기본
- [ ] DB 테이블 (mg_furniture_category, mg_furniture, mg_furniture_own, mg_room)
- [ ] 마이룸 보기 페이지
- [ ] 아이소메트릭 2D 렌더링

### D.2 가구 시스템
- [ ] 가구 카테고리 (침대, 책상, 조명 등)
- [ ] 가구 배치/회전
- [ ] 벽지/바닥 변경
- [ ] 방 크기 확장

### D.3 관리자
- [ ] 가구 등록
- [ ] 아이소메트릭 이미지 업로드
- [ ] 그리드 크기 설정

---

## 2차-E: VN Engine (역극 → 비주얼 노벨 변환)

> 역극(RP)으로 쌓인 대화 데이터를 비주얼 노벨 형식으로 자동 변환하여 리플레이.
> 상세: `docs/plans/VN_ENGINE.md`

### E.0 VN Engine 이식
- [ ] 기존 VN Engine 코드를 `plugin/vn_engine/`에 이식
- [ ] VN 테이블을 `mg_vn_*` 접두어로 변경, morgan.php에 등록
- [ ] DB 마이그레이션 작성
- [ ] 인증 연동 (Morgan 회원 시스템)
- [ ] 이미지 경로 `data/vn/` 구조로 통일

### E.1 자동 변환 API
- [ ] RP 스레드 → VN 프로젝트 변환 엔드포인트
- [ ] 참여 캐릭터 → VN 캐릭터 자동 등록 (ch_thumb 연동)
- [ ] RP 이음 → dialogue 노드 순서대로 생성
- [ ] 첨부 이미지 → CG 노드 또는 배경 전환
- [ ] 중복 변환 방지

### E.2 RP 페이지 UI
- [ ] 완결 역극에 "VN으로 보기" 버튼 추가
- [ ] 미변환 시 "VN 생성" → 변환 → 플레이어 오픈
- [ ] 변환 완료 시 바로 플레이어 오픈

### E.3 VN 플레이어 임베드
- [ ] play.php를 iframe/SPA 모달로 임베드
- [ ] 공유 링크 생성 (외부 접속 가능)
- [ ] 자동/수동 진행, 속도 조절

### E.4 변환 후 편집 (선택)
- [ ] 배경/BGM 수동 설정
- [ ] 나레이션 노드 추가/삭제
- [ ] 선택지 분기 추가

### E.5 관리자
- [ ] VN 프로젝트 목록/삭제
- [ ] 기본 배경/BGM 셋 관리
- [ ] 변환 설정 (자동 변환 허용, 최소 이음 수 등)

---

## 2차-F: SRPG 전투 시스템

> 그리드 기반 턴제 Co-op PvE 전투. 파이어 엠블렘/FFT 스타일 택틱스.
> 상세: `docs/plans/morgan_srpg_system_plan.md`

### F.0 공통 인프라 (B와 공유 가능)
- [ ] Supabase Realtime 채널 관리 모듈
- [ ] 파티 모집 로비 + 대기실 시스템
- [ ] 전투 세션 생명주기 관리 (생성 → 진행 → 종료)
- [ ] 전투 보상 연동 (포인트, 재료, 업적)

### F.1 그리드 맵 시스템
- [ ] DB 테이블 (srpg_stages, srpg_stage_tiles, srpg_stage_spawns)
- [ ] CSS Grid 기반 맵 렌더링 (가변 크기, 기본 15x15)
- [ ] 타일 타입 6종 (일반/이동불가/함정/디버프/버프/회복)
- [ ] 관리자 맵 에디터 (타일 배치, 스폰 위치, 커스텀 타일 이미지)

### F.2 캐릭터 전투 스탯
- [ ] DB 테이블 (srpg_char_stats, srpg_skills, srpg_char_skills)
- [ ] SRPG 전용 스탯 8종 (HP/MP/ATK/DEF/MAG/RES/SPD/MOV)
- [ ] 스킬 슬롯 (기본 2 + 연구/상점으로 최대 4)
- [ ] 스킬 속성 (타입/MP/사거리/범위형태/범위크기/데미지공식/추가효과/쿨타임)
- [ ] 데미지 공식 파서 (안전한 수식 평가, eval 금지)

### F.3 보스 몬스터
- [ ] DB 테이블 (srpg_monsters, srpg_monster_phases, srpg_actions, srpg_monster_phase_actions)
- [ ] 보스 등록 (이름/이미지/스탯/크기/페이즈 구간)
- [ ] 행동 개별 등록 (범위/공식/전조 텍스트/위험 범위 표시)
- [ ] 페이즈별 행동 매핑 + 가중치 기반 랜덤 선택
- [ ] 전조 → 실행 2턴 사이클

### F.4 턴 시스템 + 전투 로직
- [ ] DB 테이블 (srpg_battles, srpg_battle_members, srpg_battle_state, srpg_battle_log)
- [ ] SPD 기반 턴 순서 결정 (유저 + 보스 통합)
- [ ] 턴 내 행동: 이동(MOV 범위) → 스킬(사거리 내) → 대기
- [ ] 턴 제한 시간 (1~3분, 타임아웃 시 자동 대기)
- [ ] 이동 범위 / 스킬 범위 / 위험 범위 하이라이트
- [ ] 승리(보스 HP 0) / 패배(파티 전멸) 판정

### F.5 프론트 UI
- [ ] CSS Grid 맵 + absolute 배치 캐릭터/보스
- [ ] 이동 애니메이션 (CSS transition)
- [ ] 데미지 팝업 + 피격 연출 (CSS animation)
- [ ] 전조 표시 (빨간 반투명 오버레이 + 말풍선)
- [ ] 턴 순서 UI + 타이머
- [ ] Canvas 이펙트 오버레이 (확장용)

### F.6 확장
- [ ] PvP 아레나 (유저 vs 유저)
- [ ] 이벤트 던전 (기간 한정, 랭킹 보상)
- [ ] 장비 시스템 (스탯 보정)
- [ ] 상태이상 체계 (독/화상/빙결/스턴/침묵)
- [ ] 리플레이 (battle_log 기반 전투 재생)
- [ ] 점령전 연동 (진영 결전을 SRPG로)

---

## 구현 참고사항

### SRPG 데미지 공식 처리

기획서의 `ATK * 1.5 - target.DEF * 0.5` 같은 문자열 공식은 보안상 `eval()` 사용 금지.
구현 시 아래 중 하나를 선택:

1. **화이트리스트 토큰 파서**: 허용된 변수(ATK, DEF 등)와 연산자만 파싱
2. **프리셋 공식**: 관리자가 계수만 입력, 공식 패턴은 코드에 고정
   - 예: 물리 = `ATK * {계수} - target.DEF * {계수}`
3. **matheval 라이브러리**: PHP 수식 평가 라이브러리 도입

권장: 초기 구현은 **프리셋 공식(2번)**으로, 확장 시 **토큰 파서(1번)**로 전환.

### B/F 공통 인프라 추출 시점

B(SS Engine)과 F(SRPG) 중 먼저 착수하는 쪽에서 공통 모듈을 구현:
- `plugin/morgan/battle/` — 파티 로비, Supabase 채널, 세션 관리, 보상 연동
- 나중에 착수하는 쪽이 이 모듈을 재사용

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-23 | ROADMAP.md에서 2차 섹션 분리, 별도 문서 생성 |
| 2026-02-23 | 2차-F SRPG 추가 (morgan_srpg_system_plan.md 기반, 타당성 검토 반영) |

---

*이 문서는 개발 진행에 따라 지속적으로 업데이트됩니다.*
