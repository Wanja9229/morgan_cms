# 연구 트리 시스템 기획

## 핵심 컨셉

개척 시스템의 **전제 조건 + 재화 싱크 + 커뮤니티 성장 트리**.
재화를 공동 투입하여 연구를 완료하면 전체 커뮤니티에 영구 버프가 적용되거나 새 시설 건설이 해금된다.
건설에는 노동력+재료, 연구에는 재화. 역할이 분리되어 경제가 꼬이지 않는다.

---

## 흐름

```
재화 공동 투입 → 연구 완료 → 보상 적용 (전체 버프 or 시설 해금)
                                ↓
                    건설 목록에 새 시설 등장 (해금 계열인 경우)
                                ↓
                    노동력 + 재료 투입 → 시설 건설 → 기능 해금
```

### 자원 역할 분리

| 자원 | 획득 경로 | 소모처 |
|------|----------|-------|
| 노동력 (스태미나) | 일일 자동 지급 | 건물 건설, 탐색 파견 |
| 재료 | 파견, 활동 보상, 상점 | 건물 건설 |
| 재화 | 활동, 좋아요, 역극, 파견(소량) | **연구**, 상점, 역극 판 세우기, VN 변환 |

---

## 연구 트리 구조

### 선행 조건 체계

연구 항목 간에 선행 조건을 설정하여 트리를 구성한다.
관리자가 자유롭게 커스텀 가능.

```
[기초 측량] ─────→ [목재 가공법] ──┐
     │                             ├→ [역극장 설계도]
     └──→ [석조 건축론] ───────────┘
                │
                └──→ [채굴 효율화]
```

- 1번을 해금해야 1-1이 개발 가능
- 1-1과 2가 해금되어야 3을 개발 가능
- 복수 선행 조건 지원 (AND 조건)

### 예시 트리

```
Tier 1 (선행 없음)
├── 기초 측량         재화 1,000   → 시설 해금: 작업장
├── 자원 탐사 기초     재화 1,200   → 파견 슬롯 +1
└── 교류의 시작       재화  800    → 좋아요 횟수 +2

Tier 2 (Tier 1 필요)
├── 목재 가공법       재화 2,000   → 시설 해금: 도서관 (← 기초 측량)
├── 석조 건축론       재화 2,000   → 시설 해금: 연구소 (← 기초 측량)
├── 채굴 효율화       재화 1,800   → 파견 시간 10% 단축 (← 자원 탐사 기초)
└── 공감의 확산       재화 1,500   → 좋아요 받는 쪽 보상 +5 (← 교류의 시작)

Tier 3 (Tier 2 복수 필요)
├── 역극장 설계도     재화 3,500   → 시설 해금: 역극장 (← 목재 가공법 + 석조 건축론)
└── 물류 혁신        재화 3,000   → 인벤토리 슬롯 +5 (← 채굴 효율화 + 기초 측량)
```

> 위 트리는 기획 의도를 보여주는 예시. 관리자가 자유롭게 구성.

---

## 보상 타입

### A. 용량/한도 확장

| 보상 타입 | 설명 | 예시 값 |
|----------|------|--------|
| `inventory_slot` | 인벤토리 재료 종류 보유 한도 확장 | +3, +5 |
| `expedition_slot` | 동시 파견 슬롯 추가 | +1 |
| `like_daily_limit` | 일일 좋아요 횟수 추가 | +1, +2 |
| `stamina_max` | 일일 스태미나 최대치 증가 | +2, +3 |

### B. 효율 버프

| 보상 타입 | 설명 | 예시 값 |
|----------|------|--------|
| `expedition_speed` | 파견 소요시간 단축 (전체 적용) | -10%, -15% |
| `like_reward_giver` | 좋아요 누른 사람 보상 증가 | +5 |
| `like_reward_receiver` | 좋아요 받은 사람 보상 증가 | +5 |
| `rp_complete_bonus` | 역극 완결 보상 증가 | +50 |
| `rp_chain_ease` | 잇기 보상 기준 댓글 수 완화 | 10→8 |

### C. 해금

| 보상 타입 | 설명 | 예시 값 |
|----------|------|--------|
| `unlock_facility` | 특정 시설 건설 가능 | 시설 ID |
| `unlock_expedition` | 특정 파견지 개방 | 파견지 ID |
| `unlock_board` | 특정 게시판 개방 | 게시판 테이블명 |

> 관리자가 연구 항목 등록 시 보상 타입 드롭다운에서 선택 + 값 입력.
> 복수 보상도 가능 (연구 하나에 보상 여러 개).

---

## 인벤토리 제한

### 변경 사항

- 기존: 재료 보유 무제한
- 변경: **재료 종류 슬롯 제한** (기본값: 관리자 설정, 예: 8종)

### 규칙

- 슬롯 = 보유 가능한 재료 **종류** 수 (수량은 무제한)
- 슬롯 8이면 목재, 석재, 철광석, 마법석, 책, 유리, 희귀서적, 레어재료 → 8종 꽉 참
- 새 재료를 얻으려면 기존 재료를 건물에 투입하거나 상점에서 매각
- 연구로 슬롯 확장 가능

### 효과

- 재료를 무한정 쌓아두고 한 번에 몰아 짓기 방지
- "인벤 꽉 찼으니 이 재료 먼저 써야지" → 게임루프 회전 촉진
- 슬롯 확장 연구에 재화 투입 동기 부여

---

## DB 스키마

### mg_research — 연구 항목

| 컬럼 | 타입 | 설명 |
|------|------|------|
| rs_id | int PK | 연구 ID |
| rs_name | varchar(100) | 연구 이름 |
| rs_desc | text | 설명 |
| rs_icon | varchar(200) | 아이콘 |
| rs_cost | int | 필요 재화 (공동 투입 목표) |
| rs_current | int DEFAULT 0 | 현재 투입된 재화 |
| rs_status | enum | `locked`, `available`, `in_progress`, `complete` |
| rs_tier | int | 트리 단계 (시각화용) |
| rs_order | int | 같은 티어 내 정렬 |
| rs_complete_date | datetime NULL | 완료 일시 |

### mg_research_require — 선행 조건

| 컬럼 | 타입 | 설명 |
|------|------|------|
| rr_id | int PK | |
| rs_id | int | 연구 ID |
| require_rs_id | int | 선행 연구 ID |

> 복수 행 = AND 조건. rs_id: 4에 require_rs_id: 2, 3이면 둘 다 완료해야 4 해금.

### mg_research_reward — 연구 보상

| 컬럼 | 타입 | 설명 |
|------|------|------|
| rw_id | int PK | |
| rs_id | int | 연구 ID |
| rw_type | varchar(50) | 보상 타입 (`inventory_slot`, `expedition_slot`, `unlock_facility` 등) |
| rw_value | varchar(100) | 보상 값 (숫자 or ID) |

> 연구 하나에 보상 여러 개 가능.

### mg_research_contrib — 연구 기여 기록

| 컬럼 | 타입 | 설명 |
|------|------|------|
| rc_id | int PK | |
| rs_id | int | 연구 ID |
| mb_id | varchar(20) | 기여 회원 |
| rc_amount | int | 투입 재화량 |
| rc_datetime | datetime | 투입 시각 |

> 기여 랭킹 산출용. 명예의 전당 연동.

### 기존 테이블 수정

| 테이블 | 수정 | 설명 |
|--------|------|------|
| mg_facility | `unlock_rs_id` INT NULL 추가 | 건설 전제 연구 ID |
| mg_expedition_area | `unlock_rs_id` INT NULL 추가 | 파견지 전제 연구 ID |
| mg_member_ext (또는 mg_config) | `inventory_max_slot` 추가 | 인벤토리 슬롯 한도 |

---

## 관리자 기능

### 연구 관리 페이지

| 기능 | 설명 |
|------|------|
| 연구 등록 | 이름, 설명, 아이콘, 필요 재화, 티어 |
| 선행 조건 설정 | 기존 연구 목록에서 체크박스 선택 (복수 가능) |
| 보상 설정 | 보상 타입 드롭다운 + 값 입력 (복수 추가 가능) |
| 해금 대상 매핑 | 시설/파견지/게시판 드롭다운 선택 |
| 상태 관리 | 강제 완료, 리셋, 삭제 |
| 기여 로그 | 연구별 기여자 목록 + 랭킹 조회 |

### 인벤토리 설정

| 설정 | 기본값 | 설명 |
|------|-------|------|
| 기본 슬롯 수 | 8 | 신규 커뮤니티 시작 시 재료 종류 한도 |
| 슬롯 최대치 | 20 | 연구로 확장 가능한 상한 |

---

## 프론트 UI 방향

### 연구 트리 페이지

```
┌──────────────────────────────────────────────┐
│              [ 🔬 연구소 ]                    │
├──────────────────────────────────────────────┤
│                                              │
│  Tier 1                                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐    │
│  │ 🔍 기초   │ │ ⛏ 자원   │ │ ❤ 교류의 │    │
│  │ 측량      │ │ 탐사기초  │ │ 시작     │    │
│  │ ✅ 완료   │ │ 진행 64% │ │ 🔒 잠김  │    │
│  └────┬─────┘ └────┬─────┘ └──────────┘    │
│       │             │                        │
│  Tier 2│             │                        │
│  ┌────┴────┐ ┌─────┴────┐                  │
│  │ 🪵 목재  │ │ ⛏ 채굴   │                  │
│  │ 가공법   │ │ 효율화    │                  │
│  │ 🔒 잠김  │ │ 🔒 잠김   │                  │
│  └────┬────┘ └──────────┘                   │
│       │                                      │
│  Tier 3│                                      │
│  ┌────┴─────────────────┐                   │
│  │ 🎭 역극장 설계도       │                   │
│  │ 선행: 목재가공 + 석조건축│                   │
│  │ 🔒 잠김                │                   │
│  └───────────────────────┘                   │
│                                              │
└──────────────────────────────────────────────┘
```

### 연구 상세 (진행 중)

```
┌──────────────────────────────────────────────┐
│  ⛏ 자원 탐사 기초                             │
│  "체계적 탐사 방법론을 확립합니다"               │
│                                              │
│  ████████████████░░░░░░░░  64.0%             │
│  💰 768 / 1,200                              │
│                                              │
│  보상: 파견 슬롯 +1                           │
│                                              │
│  ┌────────────────────────────────────┐      │
│  │ 투입할 재화:  [  100  ]  [ 투입하기 ]│      │
│  └────────────────────────────────────┘      │
│                                              │
│  ── 기여 랭킹 ──                              │
│  🥇 다니엘    230                             │
│  🥈 레이첼    195                             │
│  🥉 민수      143                             │
│                                              │
└──────────────────────────────────────────────┘
```

### 인벤토리 표시 (글로벌 리소스 바 확장)

```
┌─────────────────────────────────────────────┐
│ ⚡ 7/10  │  🎒 6/8  │  💰 1,250              │
│ 스태미나   │ 인벤토리  │  재화                 │
└─────────────────────────────────────────────┘

🎒 클릭 시 펼침:
┌───────────────────────┐
│ 🪵 목재      ×23      │
│ 🪨 석재      ×15      │
│ ⛏ 철광석     ×8       │
│ 📖 책        ×12      │
│ 💎 마법석     ×3       │
│ 🔮 유리      ×7       │
│ [빈 슬롯]             │
│ [빈 슬롯]             │
│ ────────────────────  │
│ 6/8 종류 보유 중       │
└───────────────────────┘
```

---

## 구현 우선순위

```
[1단계] 인벤토리 슬롯 제한 (난이도: 낮음)
├── mg_member_ext에 슬롯 필드 추가
├── 재료 획득 시 슬롯 체크 로직
├── 인벤토리 UI 수정
└── 관리자 기본 슬롯 수 설정

[2단계] 연구 테이블 + 관리자 CRUD (난이도: 중간)
├── mg_research, mg_research_require, mg_research_reward, mg_research_contrib
├── 관리자 연구 등록/수정/삭제
├── 선행 조건 설정 UI
└── 보상 타입 드롭다운

[3단계] 연구 투입 + 완료 로직 (난이도: 중간)
├── 재화 투입 AJAX 처리
├── 완료 시 보상 적용 (전역 설정값 변경)
├── 선행 조건 자동 해금 체크
└── 기여 랭킹 산출

[4단계] 프론트 연구 트리 페이지 (난이도: 중간)
├── 티어별 트리 시각화
├── 연구 상세 + 투입 UI
├── 진행률 바 + 기여 랭킹
└── 개척 메인에서 연구소 탭 추가
```

---

## 전체 경제 싱크 요약

| 소모처 | 단위 | 자원 | 비고 |
|--------|------|------|------|
| 건물 건설 | 공동 | 노동력 + 재료 | 기능 해금 |
| 연구 | 공동 | **재화** | 버프 + 건설 전제조건 |
| 역극 판 세우기 | 개인 | 재화 500 | 완결 시 리턴 |
| VN 변환 | 개인 | 재화 (미정) | 완결 역극 변환 |
| 상점 치장템 | 개인 | 재화 1,500~3,000 | 일주일~열흘치 |
| 상점 서브캐릭터권 | 개인 | 재화 10,000~15,000 | 한달~두달치 |

**공동 싱크** (연구 + 건설) + **개인 싱크** (역극 + 상점) 양쪽에서 재화가 빠지므로 인플레 제어 가능.

---

*버전: 1.0*
*관련 문서: PIONEER.md, PIONEER_EXPANSION.md, ROLEPLAY_ECONOMY.md*
*다음 작업: 기존 개척 시스템에 연구 전제조건 필드 추가*
