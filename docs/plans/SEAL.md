# 인장 시스템 기획 (Seal / Signature Card)

> Morgan Edition - 유저 시그니처 카드 시스템
> 관련: SHOP.md (꾸미기 아이템), ACHIEVEMENT.md (트로피 쇼케이스), CHARACTER.md (프로필)

---

## 기획 의도

**"내 글 하단에 자동으로 붙는 나만의 명함"**

게시글 하단, 캐릭터 프로필 하단 등에 자동 표시되는 개인 시그니처 카드.
단순 텍스트 서명이 아닌, 커스텀 가능한 시각적 명함으로서:

- **자기 표현**: 한마디, 대표 캐릭터, 트로피, 이미지로 정체성 전시
- **꾸미기 아이템 전시 공간**: 상점에서 구매한 스킨/프레임이 실제로 보이는 곳
- **업적 통합 쇼케이스**: 달성 트로피를 인장에 진열
- **소셜 시그널**: "이 유저는 이런 사람/이런 캐릭터를 굴리는구나"
- **상점 구매 동기**: 인장 꾸미기 = 가장 눈에 잘 띄는 치장 → 재화 싱크

레퍼런스: 인벤토리 인장, Steam 프로필, 포럼 시그니처

---

## 핵심 개념

### 인장 (Seal)

- 계정당 1개 (mb_id 단위)
- 모든 게시글/역극 이음 하단에 자동 표시
- 캐릭터 프로필 페이지 하단 "소유자 정보"에도 표시
- 유저가 직접 편집 (관리자 제공 기능 범위 내 커스텀)
- 인장 사용 여부 ON/OFF 가능 (기본 ON)

### 인장 구성 요소

```
┌─────────────────────────────────────────────────────────────┐
│ [배경 스킨] ─────────────────────────────────────────────── │
│                                                             │
│  ┌──────┐  닉네임  ★칭호★                    ┌───┐┌───┐   │
│  │ 대표 │  한마디: "오늘도 열심히 굴린다"      │🏆 ││🎭 │   │
│  │ 캐릭 │                                    │트 ││트 │   │
│  │ 썸네 │  ── 자유 영역 ──────────────────   │로 ││로 │   │
│  │ 일   │  텍스트, 이미지, 링크 등            │피 ││피 │   │
│  │      │  유저가 자유롭게 편집               │1  ││2  │   │
│  └──────┘                                    └───┘└───┘   │
│                                                             │
│  [프레임/테두리 스킨] ──────────────────────────────────────  │
└─────────────────────────────────────────────────────────────┘
```

| 영역 | 설명 | 데이터 소스 |
|------|------|------------|
| 대표 캐릭터 | 메인 캐릭터 썸네일 (자동) | mg_character (ch_main=1) |
| 닉네임 | 회원 닉네임 (자동) | g5_member.mb_nick |
| 칭호 | 착용 중인 칭호 (자동) | mg_item_active (title) |
| 한마디 | 유저 직접 입력 (최대 50자) | mg_seal.seal_tagline |
| 트로피 슬롯 | 업적 쇼케이스 (선택) | mg_user_achievement_display |
| 자유 영역 | 텍스트/이미지/링크 편집 | mg_seal.seal_content |
| 배경 스킨 | 상점 아이템 (선택) | mg_item_active (seal_bg) |
| 프레임 스킨 | 상점 아이템 (선택) | mg_item_active (seal_frame) |

---

## 인장 편집

### 편집 가능 항목

| 항목 | 편집 방식 | 제한 |
|------|----------|------|
| 한마디 | 텍스트 입력 | 최대 50자, 금지어 필터 |
| 자유 영역 | 제한된 에디터 | 최대 300자 + 이미지 1장 |
| 트로피 배치 | 업적 목록에서 선택 | 최대 3~5개 (슬롯) |
| 배경 스킨 | 인벤토리에서 적용 | 상점 구매 아이템 |
| 프레임 스킨 | 인벤토리에서 적용 | 상점 구매 아이템 |
| 대표 캐릭터 | 캐릭터 설정에서 변경 | 승인된 캐릭터만 |
| 인장 ON/OFF | 토글 | 끄면 어디서도 안 보임 |

### 자유 영역 에디터

풀 에디터가 아닌 **제한된 입력 방식**:

| 허용 | 비허용 |
|------|--------|
| 텍스트 (줄바꿈 포함) | HTML 태그 직접 입력 |
| 이미지 1장 (URL 또는 업로드) | 스크립트, iframe |
| 링크 1개 (자동 하이퍼링크) | 외부 위젯/임베드 |
| 이모티콘 (보유한 셋) | 동영상 |
| 텍스트 색상 (기본 제공 팔레트) | 커스텀 CSS/HTML |

> 보안: XSS 방지를 위해 입력값 새니타이징 필수. 허용 태그 화이트리스트 적용.

### 이미지 규칙

| 항목 | 값 |
|------|---|
| 최대 크기 | 500KB |
| 허용 형식 | jpg, png, gif, webp |
| 최대 해상도 | 600×200 (배너형) |
| 저장 경로 | `/data/seal/{mb_id}/` |
| 외부 URL | 허용 (관리자 설정으로 OFF 가능) |

---

## 꾸미기 아이템 (상점 연동)

### 신규 상품 타입

| 타입 코드 | 설명 | si_effect 예시 |
|-----------|------|---------------|
| `seal_bg` | 인장 배경 스킨 | `{"type":"seal_bg","bg_image":"/data/shop/seal_bg_001.jpg","bg_color":"#1a1a2e"}` |
| `seal_frame` | 인장 프레임/테두리 | `{"type":"seal_frame","border_image":"/data/shop/seal_frame_001.png","border_color":"#8b5cf6"}` |

> 기존 `si_type` enum에 `seal_bg`, `seal_frame` 추가.
> 기존 인프라(`mg_item_active`, `mg_get_active_items()`) 그대로 활용.

### 기본 제공 스킨

상점 구매 없이 사용 가능한 기본 스킨:

| 스킨 | 설명 |
|------|------|
| 기본 (default) | Morgan 테마 다크 배경, 테두리 없음 |
| 심플 라인 | 얇은 보더만 있는 깔끔한 스타일 |
| 그라데이션 | mg-accent 계열 은은한 그라데이션 |

> 기본 스킨은 상점 아이템이 아닌 시스템 내장. 적용 아이템 없으면 기본 렌더링.

### 스킨 적용 우선순위

```
1. 상점 아이템 적용 중 → 해당 스킨
2. 아이템 없음 → 기본(default) 스킨
3. 인장 OFF → 렌더링 안 함
```

---

## 트로피 연동 (업적 시스템)

### 인장 내 트로피 슬롯

- 업적 시스템의 프로필 쇼케이스(`mg_user_achievement_display`)를 인장에 표시
- 기존 설계: 3~5개 슬롯에 달성 업적 선택
- 인장에서는 이 슬롯을 시각적으로 렌더링

```
┌───┐ ┌───┐ ┌───┐
│🏆│ │🎭│ │🔨│
│Rar│ │Epc│ │Com│
└───┘ └───┘ └───┘
글쟁이 이야기꾼 건설
 III    II   노동자
```

- 트로피 아이콘 + 희귀도 테두리 색상
- 호버 시 업적 이름 + 설명 툴팁
- 트로피 슬롯 수 확장: 시설 해금 또는 연구로 가능 (개척 연동)

### 트로피 없을 때

- 빈 슬롯 표시 안 함 (공간 자동 축소)
- 또는 "업적을 달성하면 여기에 표시됩니다" 안내 (관리자 설정)

---

## 자동 표시 영역

인장이 자동으로 노출되는 위치:

| 위치 | 파일 | 표시 조건 |
|------|------|----------|
| 게시글 view 하단 | `theme/morgan/skin/board/*/view.skin.php` | 글 작성자의 인장 |
| 역극 이음 하단 | `theme/morgan/skin/rp/reply.skin.php` | 이음 작성자의 인장 (접힘/펼침) |
| 캐릭터 프로필 하단 | `bbs/character_view.php` | 캐릭터 소유자의 인장 |
| 유저 프로필 페이지 | `bbs/member_profile.php` (신규) | 해당 유저의 인장 |

### 표시 모드

| 모드 | 사용처 | 설명 |
|------|--------|------|
| `full` | 게시글 view, 유저 프로필 | 전체 인장 표시 |
| `compact` | 역극 이음, 댓글 | 축소 버전 (대표캐릭+닉+칭호+한마디만) |
| `hidden` | 인장 OFF 유저 | 렌더링 안 함 |

### compact 모드

역극 이음이나 댓글처럼 반복 노출되는 곳에서는 축소 표시:

```
┌──────────────────────────────────────────┐
│ [썸네일] 닉네임 ★칭호★ "한마디..."       │
└──────────────────────────────────────────┘
```

- 클릭/탭 시 full 모드로 펼침 (또는 유저 프로필 링크)

---

## DB 스키마

### mg_seal — 인장 데이터

| 컬럼 | 타입 | 설명 |
|------|------|------|
| seal_id | int PK AUTO_INCREMENT | |
| mb_id | varchar(20) UNIQUE | 회원 ID (1인 1인장) |
| seal_use | tinyint DEFAULT 1 | 인장 사용 여부 (0=OFF) |
| seal_tagline | varchar(100) | 한마디 (최대 50자, 여유 확보) |
| seal_content | text | 자유 영역 콘텐츠 |
| seal_image | varchar(500) NULL | 자유 영역 이미지 경로 |
| seal_link | varchar(500) NULL | 자유 영역 링크 URL |
| seal_link_text | varchar(100) NULL | 링크 표시 텍스트 |
| seal_text_color | varchar(7) NULL | 텍스트 색상 (#hex, NULL=기본) |
| seal_update | datetime | 최종 수정일 |

> 배경/프레임 스킨은 `mg_item_active` 테이블에서 조회 (기존 인프라).
> 트로피 슬롯은 `mg_user_achievement_display` 테이블에서 조회 (기존 설계).
> 대표 캐릭터는 `mg_character WHERE mb_id AND ch_main=1` 조회.
> 칭호는 `mg_item_active WHERE mb_id AND ia_type='title'` 조회.

### 테이블 관계도

```
mg_seal (인장 콘텐츠)
    │
    ├── g5_member (닉네임)
    ├── mg_character (대표 캐릭터, ch_main=1)
    ├── mg_item_active (칭호, 배경 스킨, 프레임 스킨)
    ├── mg_user_achievement_display (트로피 슬롯)
    └── mg_emoticon_own (사용 가능한 이모티콘)
```

> 인장 렌더링 시 위 테이블들을 JOIN하여 한 번에 조회.
> 캐싱 권장: 인장 데이터는 수정 빈도 낮음 → 세션 또는 단기 캐시 적용.

---

## 렌더링 함수

### mg_render_seal($mb_id, $mode = 'full')

```php
/**
 * 인장 렌더링
 * @param string $mb_id   회원 ID
 * @param string $mode    'full' | 'compact'
 * @return string          HTML
 */
function mg_render_seal($mb_id, $mode = 'full') {
    // 1. mg_seal 조회 (seal_use 체크)
    // 2. seal_use = 0 이면 빈 문자열 반환
    // 3. 관련 데이터 조회:
    //    - g5_member (닉네임)
    //    - mg_character (대표 캐릭터 썸네일)
    //    - mg_item_active (칭호, seal_bg, seal_frame)
    //    - mg_user_achievement_display (트로피)
    // 4. $mode에 따라 full/compact 템플릿 렌더링
    // 5. HTML 반환
}
```

### 호출 위치

```php
// view.skin.php (게시글 하단)
echo mg_render_seal($write['mb_id'], 'full');

// rp reply (역극 이음)
echo mg_render_seal($reply['mb_id'], 'compact');

// character_view.php (캐릭터 프로필 하단)
echo mg_render_seal($character['mb_id'], 'full');
```

---

## 프론트 UI

### 인장 편집 페이지 (bbs/seal_edit.php)

```
┌─────────────────────────────────────────────────────────────┐
│  내 인장 편집                                     [미리보기] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  인장 사용: [ON ●───── OFF]                                 │
│                                                             │
│  ── 기본 정보 (자동) ─────────────────────────────────────  │
│  대표 캐릭터: 레이첼  [캐릭터 설정에서 변경]                  │
│  칭호: ★초보모험가★  [인벤토리에서 변경]                      │
│                                                             │
│  ── 한마디 ──────────────────────────────────────────────  │
│  [오늘도 열심히 굴린다________________________] 12/50자      │
│                                                             │
│  ── 자유 영역 ───────────────────────────────────────────  │
│  [텍스트 입력 영역 (줄바꿈 가능)                             │
│   최대 300자                                                │
│   ___________________________________________________]     │
│                                                    187/300  │
│                                                             │
│  이미지: [파일 선택] 또는 [URL 입력]                         │
│          미리보기: [썸네일]  [삭제]                           │
│                                                             │
│  링크: [https://________________________]                   │
│  링크 텍스트: [트위터_____________________]                   │
│                                                             │
│  텍스트 색상: [● 기본] [● 흰색] [● 연보라] [● 하늘] [● 커스텀]│
│                                                             │
│  ── 트로피 ──────────────────────────────────────────────  │
│  슬롯 1: [글쟁이 III ▼]                                     │
│  슬롯 2: [이야기꾼 II ▼]                                    │
│  슬롯 3: [선택 안 함 ▼]                                     │
│  [업적 페이지에서 더 보기]                                    │
│                                                             │
│  ── 스킨 ────────────────────────────────────────────────  │
│  배경:  [기본 ▼] / [내 아이템에서 선택]                      │
│  프레임: [기본 ▼] / [내 아이템에서 선택]                     │
│  [상점에서 스킨 구매하기 →]                                  │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                             │
│  미리보기:                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ (실시간 미리보기 영역)                                  │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│                                          [저장]  [초기화]   │
└─────────────────────────────────────────────────────────────┘
```

### 인장 표시 — full 모드

```
┌─ 인장 ──────────────────────────────────────────────────────┐
│ [배경 스킨 적용]                                             │
│                                                             │
│  ┌──────┐                                    ┌───┐┌───┐   │
│  │      │  닉네임  ★초보모험가★               │🏆 ││🎭 │   │
│  │ [대표 │  "오늘도 열심히 굴린다"             │Rar││Epc│   │
│  │  캐릭 │                                   └───┘└───┘   │
│  │  썸네 │  자유 영역 텍스트가 여기에           ┌───┐       │
│  │  일]  │  표시됩니다.                        │🔨 │       │
│  │      │                                    │Com│       │
│  └──────┘  [이미지]  🔗 트위터                └───┘       │
│                                                             │
│ [프레임 스킨 적용]                                           │
└─────────────────────────────────────────────────────────────┘
```

### 인장 표시 — compact 모드

```
┌─────────────────────────────────────────────────────────────┐
│ [썸네일] 닉네임 ★초보모험가★  "오늘도 열심히 굴린다"         │
└─────────────────────────────────────────────────────────────┘
```

---

## 인장 없는 유저 처리

| 상황 | 처리 |
|------|------|
| 인장 미생성 (신규 유저) | 첫 접속 시 기본 인장 자동 생성 (빈 상태) |
| 인장 OFF | 해당 위치에 아무것도 표시 안 함 |
| 대표 캐릭터 없음 | 기본 실루엣 아이콘 표시 |
| 칭호 없음 | 칭호 영역 생략 |
| 트로피 없음 | 트로피 영역 생략 (빈 슬롯 안 보임) |
| 자유 영역 비어있음 | 해당 영역 생략 |

> 빈 인장이라도 닉네임은 항상 표시. 최소한의 인장 = 닉네임만 있는 카드.

---

## 관리자 기능

### 인장 관리 (adm/morgan/seal.php)

| 기능 | 설명 |
|------|------|
| 전체 인장 목록 | 회원별 인장 조회 (검색, 필터) |
| 인장 내용 검열 | 부적절한 이미지/텍스트 확인 + 강제 초기화 |
| 인장 강제 OFF | 특정 유저 인장 비활성화 |
| 금지어 관리 | 한마디/자유 영역 금지어 목록 |

### 인장 설정 (mg_config)

| 설정 키 | 기본값 | 설명 |
|---------|-------|------|
| `seal_enable` | 1 | 인장 시스템 전체 ON/OFF |
| `seal_tagline_max` | 50 | 한마디 최대 글자수 |
| `seal_content_max` | 300 | 자유 영역 최대 글자수 |
| `seal_image_upload` | 1 | 이미지 직접 업로드 허용 |
| `seal_image_url` | 1 | 외부 이미지 URL 허용 |
| `seal_image_max_size` | 500 | 이미지 최대 크기 (KB) |
| `seal_link_allow` | 1 | 링크 허용 |
| `seal_trophy_slots` | 3 | 트로피 슬롯 수 (기본) |
| `seal_show_in_rp` | 1 | 역극 이음에서 인장 표시 여부 |
| `seal_show_in_comment` | 0 | 댓글에서 인장 표시 여부 (기본 OFF) |
| `seal_compact_in_rp` | 1 | 역극에서 compact 모드 사용 |
| `seal_auto_create` | 1 | 신규 유저 인장 자동 생성 |

---

## 모듈 토글

| 토글 | 키 | OFF 시 |
|------|---|--------|
| 인장 시스템 전체 | `seal_enable` | 모든 위치에서 인장 비표시, 편집 메뉴 숨김 |

> "복잡한 게 싫은 관리자"는 `seal_enable = 0`으로 끄면 끝.

---

## 기존 시스템 연동 정리

| 시스템 | 연동 내용 | 방향 |
|--------|----------|------|
| 상점 | `seal_bg`, `seal_frame` 신규 상품 타입 | 상점 → 인장 |
| 업적 | 트로피 쇼케이스 슬롯을 인장에 렌더링 | 업적 → 인장 |
| 캐릭터 | 대표 캐릭터 썸네일 자동 표시 | 캐릭터 → 인장 |
| 칭호 | 착용 중인 칭호 자동 표시 | 상점 → 인장 |
| 이모티콘 | 자유 영역에 이모티콘 삽입 가능 | 이모티콘 → 인장 |
| 개척/연구 | 트로피 슬롯 수 확장 보상 가능 | 연구 → 인장 |

---

## 파일 구성

### 신규 페이지

| 파일 | 역할 |
|------|------|
| `bbs/seal_edit.php` | 인장 편집 페이지 |
| `bbs/seal_edit_update.php` | 인장 저장 처리 (AJAX) |
| `bbs/seal_image_upload.php` | 인장 이미지 업로드 처리 |
| `theme/morgan/skin/seal/full.skin.php` | full 모드 렌더링 스킨 |
| `theme/morgan/skin/seal/compact.skin.php` | compact 모드 렌더링 스킨 |
| `adm/morgan/seal.php` | 관리자 인장 관리 |

### 기존 파일 수정

| 파일 | 수정 내용 |
|------|----------|
| `plugin/morgan/morgan.php` | `mg_render_seal()` 함수 추가 |
| `plugin/morgan/install/install.sql` | mg_seal 테이블 추가 |
| `theme/morgan/skin/board/*/view.skin.php` | 글 하단에 `mg_render_seal()` 호출 |
| `theme/morgan/skin/rp/reply.skin.php` | 이음 하단에 compact 인장 호출 |
| `bbs/character_view.php` | 소유자 정보 영역에 인장 호출 |
| `theme/morgan/head.php` | 사이드바에 "내 인장" 메뉴 추가 |
| `adm/admin.menu800.php` | 관리자 메뉴에 인장 관리 추가 |

### DB 변경

| 변경 | 내용 |
|------|------|
| 신규 테이블 | `mg_seal` |
| `si_type` enum 추가 | `seal_bg`, `seal_frame` |
| `mg_config` | 인장 관련 설정값 INSERT |

---

## 구현 우선순위

```
[1단계] 기본 인장 (난이도: 낮음, 임팩트: 높음)
├── mg_seal 테이블 생성
├── 인장 편집 페이지 (한마디, 자유 영역, 이미지, 링크)
├── mg_render_seal() 함수 (full/compact)
├── 게시글 view 하단에 인장 표시
└── 캐릭터 프로필 하단에 인장 표시

[2단계] 꾸미기 연동 (난이도: 낮음)
├── seal_bg, seal_frame 상품 타입 추가
├── 인장 편집에서 스킨 선택 UI
├── 기본 제공 스킨 3종
└── 상점에서 인장 스킨 판매

[3단계] 트로피 연동 (난이도: 낮음)
├── 업적 쇼케이스를 인장에 렌더링
├── 인장 편집에서 트로피 슬롯 선택
└── 희귀도 테두리 색상 적용

[4단계] 관리자 기능 (난이도: 낮음)
├── 인장 목록/검열 페이지
├── 강제 초기화/OFF
└── 설정값 관리
```

---

## 성능 고려

| 항목 | 대응 |
|------|------|
| 게시글마다 인장 조회 | view 페이지에서만 표시 (목록에서는 안 함) |
| 역극 이음 다수 | compact 모드로 경량 렌더링 + 같은 유저 인장 캐싱 |
| JOIN 쿼리 부하 | 인장 데이터 한 번 조회 후 변수에 저장, 같은 페이지 내 재사용 |
| 이미지 로딩 | lazy loading 적용, 썸네일 자동 리사이즈 |

---

## 확장성

| 확장 | 설명 | 시기 |
|------|------|------|
| 인장 템플릿 | 관리자가 레이아웃 프리셋 제공 | 베타 피드백 후 |
| 인장 좋아요 | 다른 유저 인장에 좋아요 → 인기 인장 랭킹 | 후순위 |
| 움직이는 배경 | GIF/CSS 애니메이션 배경 스킨 (프리미엄) | 상점 확장 시 |
| 계절 한정 프레임 | 이벤트 기간 한정 인장 프레임 판매 | 시즌 이벤트 |
| 인장 공유 | 인장을 이미지로 export (SNS 공유) | 후순위 |

---

*버전: 1.0*
*작성일: 2026-02-10*
*상태: 기획 완료, 구현 대기*
*관련: SHOP.md, ACHIEVEMENT.md, CHARACTER.md, REWARD.md*
