# Phase 9: 업적 시스템 (Achievement System)

## 기획 의도

게임의 **도전과제(트로피/업적)** 시스템을 커뮤니티에 도입한다.
유저 활동에 대한 마일스톤을 설정하고, 달성 시 보상과 명예를 부여한다.
달성한 업적 중 원하는 것을 골라 프로필에 전시하여 자기 정체성을 표현할 수 있다.

이를 통해:
- **활동 동기**를 부여한다 (다음 단계까지 3개만 더 쓰면 돼!)
- **장기 목표**를 제공한다 (게시글 500개, RP 이음 1000회 등)
- **프로필 차별화**를 만든다 (이 유저는 이런 업적을 가진 사람이구나)
- 달성 보상으로 **재화/아이템 순환**을 촉진한다
- 개척 시스템과 연동하여 **커뮤니티 기여에 명예**를 부여한다

---

## 핵심 개념

### 업적 (Achievement)

- 특정 조건을 달성하면 해금되는 트로피
- 아이콘, 이름, 설명, 희귀도를 가짐
- 카테고리별 분류 (활동, 역극, 개척, 소셜, 수집, 특수 등)

### 단계형 업적 (Progressive / Tiered)

- 하나의 업적이 여러 단계를 가짐
- 예: "글쟁이" → 게시글 10 / 50 / 100 / 300 / 500 / 1000개
- 각 단계마다 별도의 이름, 아이콘, 보상 부여
- 상위 단계 달성 시 하위 단계가 자동으로 대체되는 것이 아닌, **각각 독립된 트로피**
- 끝은 있지만 충분히 먼 목표를 설정하여 지속적 동기 부여

### 일회성 업적 (One-time)

- 특정 조건 1회 충족으로 해금
- 예: "첫 출석", "첫 역극 개설", "개척 기여 1위"
- 특수 상황이나 이벤트에 적합

### 프로필 쇼케이스 (Display Slots)

- 유저가 달성한 업적 중 **3~5개를 골라** 프로필에 전시
- Steam 프로필의 업적 쇼케이스와 동일한 UX
- 다른 유저가 프로필을 보면 선택된 업적 트로피가 표시됨
- 슬롯 수는 고정 또는 시설 해금으로 확장 가능

### 희귀도 (Rarity)

- 전체 유저 중 달성 비율로 자동 산정, 또는 관리자 수동 지정
- 등급 예시: Common / Uncommon / Rare / Epic / Legendary
- 희귀도에 따라 트로피 테두리 색상/효과 차별화

---

## 업적 카테고리 (예시)

### 활동 (Activity)

| 업적 | 조건 | 단계 (예시) |
|------|------|------------|
| 글쟁이 | 게시글 작성 수 | 10 → 50 → 100 → 300 → 500 → 1000 |
| 수다쟁이 | 댓글 작성 수 | 20 → 100 → 300 → 500 → 1000 |
| 개근왕 | 연속 출석일 | 7 → 14 → 30 → 60 → 100 → 365 |
| 부자 | 보유 포인트 | 1000 → 5000 → 10000 → 50000 |
| 첫 발자국 | 첫 게시글 작성 | 일회성 |
| 단골손님 | 누적 출석일 | 30 → 100 → 365 |

### 역극 (Roleplay)

| 업적 | 조건 | 단계 (예시) |
|------|------|------------|
| 이야기꾼 | RP 이음 작성 수 | 10 → 50 → 100 → 500 → 1000 |
| 극작가 | RP 스레드 개설 수 | 1 → 5 → 10 → 30 |
| 인기 배우 | 내가 참여한 RP에 다른 유저 참여 수 | 조건 구체화 필요 |
| 대서사시 | 하나의 RP에서 이음 수 | 50 → 100 → 300 |
| 첫 무대 | 첫 RP 이음 | 일회성 |

### 개척 (Pioneer) — 개척 시스템 연동

| 업적 | 조건 | 비고 |
|------|------|------|
| 건설 노동자 | 노동력 총 투입량 | 100 → 500 → 1000 → 5000 |
| 자재왕 | 재료 총 투입량 | 50 → 200 → 500 → 2000 |
| 건축왕 | 시설 기여 1위 | 일회성 (시설마다 가능) |
| 초석 | 첫 시설 기여 | 일회성 |
| 개척자 | 시설 건설 참여 수 | 1 → 3 → 5 → 10 |

### 소셜 (Social)

| 업적 | 조건 | 비고 |
|------|------|------|
| 선물의 달인 | 선물 보낸 횟수 | 1 → 10 → 50 |
| 이모티콘 수집가 | 보유 이모티콘 셋 수 | 3 → 5 → 10 |
| 크리에이터 | 이모티콘 셋 판매 | 일회성 또는 단계형 |
| 인기인 | 프로필 조회 수 | 조건 구체화 필요 |

### 수집 (Collection)

| 업적 | 조건 | 비고 |
|------|------|------|
| 쇼핑왕 | 상점 구매 횟수 | 5 → 20 → 50 → 100 |
| 치장 달인 | 착용 중인 아이템 종류 | 3 → 5 |
| 캐릭터 수집가 | 등록 캐릭터 수 | 2 → 5 → 10 |
| 모든 재료 | 모든 종류의 재료 보유 | 일회성 |

### 특수 (Special)

| 업적 | 조건 | 비고 |
|------|------|------|
| 도서관 건립자 | 도서관 기여 TOP 3 | 해당 시설 완공 시 확정 |
| OG | 사이트 최초 N명 가입 | 일회성, 관리자 수동 부여 가능 |
| 이벤트 참여자 | 특정 이벤트 달성 | 관리자 수동/조건 지정 |

> 위 업적 목록은 예시이며, 관리자가 자유롭게 추가/수정/삭제 가능하도록 구현.
> 조건은 JSON으로 정의하여 유연하게 확장.

---

## 달성 조건 구조 (JSON)

```json
// 단순 카운트
{"type": "write_count", "target": 100}

// 특정 게시판 제한
{"type": "write_count", "board": "free", "target": 50}

// RP 이음 카운트
{"type": "rp_reply_count", "target": 500}

// 연속 출석
{"type": "attendance_streak", "target": 30}

// 누적 출석
{"type": "attendance_total", "target": 365}

// 개척 노동력 투입
{"type": "pioneer_stamina_total", "target": 1000}

// 개척 기여 순위
{"type": "pioneer_rank", "facility_id": 3, "rank": 1}

// 보유 포인트
{"type": "point_current", "target": 50000}

// 이모티콘 셋 보유
{"type": "emoticon_own_count", "target": 10}

// 상점 구매 횟수
{"type": "shop_buy_count", "target": 50}

// 수동 부여 (관리자)
{"type": "manual"}
```

---

## 보상 체계

업적 달성 시 지급 가능한 보상:

| 보상 타입 | 예시 |
|----------|------|
| 포인트 | +500P |
| 재료 | 목재 5개 |
| 상점 아이템 | 특정 칭호/뱃지 자동 지급 |
| 노동력 보너스 | 일일 노동력 +2 (영구 또는 기간 한정) |
| 인벤토리 슬롯 | +5칸 |
| 업적 전용 칭호 | "글쟁이 마스터" 등 |

> 보상도 JSON으로 정의:
```json
{"type": "point", "amount": 500}
{"type": "material", "mt_code": "wood", "amount": 5}
{"type": "item", "si_id": 42}
{"type": "stamina_bonus", "amount": 2}
{"type": "title", "value": "글쟁이 마스터"}
```

---

## DB 스키마 (개괄)

### mg_achievement - 업적 정의

| 컬럼 | 타입 | 설명 |
|------|------|------|
| ac_id | int PK | 업적 ID |
| ac_name | varchar(100) | 업적 이름 |
| ac_desc | text | 설명 |
| ac_icon | varchar(500) | 아이콘 이미지 경로 |
| ac_category | varchar(30) | 카테고리 (activity, rp, pioneer, social, collection, special) |
| ac_type | enum | `progressive`, `onetime` |
| ac_condition | text (JSON) | 달성 조건 |
| ac_rarity | enum | `common`, `uncommon`, `rare`, `epic`, `legendary` 또는 NULL(자동 산정) |
| ac_order | int | 표시 순서 |
| ac_use | tinyint(1) | 사용 여부 |

### mg_achievement_tier - 단계형 업적의 각 단계

| 컬럼 | 타입 | 설명 |
|------|------|------|
| at_id | int PK | |
| ac_id | int | 업적 ID |
| at_level | int | 단계 (1, 2, 3...) |
| at_name | varchar(100) | 단계 이름 ("글쟁이 I", "글쟁이 II"...) |
| at_target | int | 목표 수치 (10, 50, 100...) |
| at_icon | varchar(500) | 단계별 아이콘 (NULL이면 업적 기본 아이콘) |
| at_reward | text (JSON) | 단계별 보상 |

> `ac_type = 'onetime'`인 업적은 tier 테이블을 사용하지 않음.
> 조건의 target은 ac_condition JSON에, 단계형은 at_target에 각각 정의.

### mg_user_achievement - 유저별 달성 상태

| 컬럼 | 타입 | 설명 |
|------|------|------|
| ua_id | int PK | |
| mb_id | varchar(20) | 회원 ID |
| ac_id | int | 업적 ID |
| ua_progress | int | 현재 진행값 (글 작성 수 등) |
| ua_tier | int | 달성한 최고 단계 (0 = 미달성) |
| ua_completed | tinyint(1) | 완전 달성 여부 (최종 단계 또는 일회성 달성) |
| ua_datetime | datetime | 최종 달성/갱신 시각 |
| UNIQUE | (mb_id, ac_id) | |

### mg_user_achievement_display - 프로필 쇼케이스

| 컬럼 | 타입 | 설명 |
|------|------|------|
| mb_id | varchar(20) PK | 회원 ID |
| slot_1 | int NULL | 업적 ID (또는 tier ID) |
| slot_2 | int NULL | |
| slot_3 | int NULL | |
| slot_4 | int NULL | (시설 해금으로 확장 가능) |
| slot_5 | int NULL | |

> 슬롯 구조는 고정 컬럼 방식 (최대 5개) 또는 별도 행 방식 중 선택.
> 고정 컬럼이 쿼리 단순화에 유리.

---

## UI 참조: Steam 스타일

### 업적 목록 페이지 (`bbs/achievement.php`)

```
┌─────────────────────────────────────────────────┐
│  업적                            달성: 24 / 87  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   28%          │
├─────────────────────────────────────────────────┤
│  [활동] [역극] [개척] [소셜] [수집] [특수]      │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌────┐  글쟁이 III                    [달성]   │
│  │ 🏆 │  게시글 100개 작성              Rare    │
│  │    │  ━━━━━━━━━━━━━━━━ 100/100             │
│  └────┘  다음: 글쟁이 IV (300개)               │
│                                                 │
│  ┌────┐  이야기꾼 II                   [달성]   │
│  │ 🎭 │  RP 이음 50회 작성           Uncommon   │
│  │    │  ━━━━━━━━━━━━━━━━ 50/50               │
│  └────┘  다음: 이야기꾼 III (100회)            │
│                                                 │
│  ┌────┐  건설 노동자 I               [진행중]   │
│  │ 🔨 │  노동력 100 투입              Common    │
│  │    │  ━━━━━━━━━━━━░░░░ 72/100              │
│  └────┘                                        │
│                                                 │
│  ┌────┐  건축왕                       [미달성]   │
│  │ ?? │  시설 기여 1위                Legendary  │
│  │    │  ░░░░░░░░░░░░░░░░                     │
│  └────┘                                        │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 프로필 쇼케이스 영역

```
┌──── 프로필 ────────────────────────────────────┐
│                                                 │
│  [캐릭터 이름]  @닉네임                         │
│                                                 │
│  ── 업적 쇼케이스 ──                            │
│  ┌────┐  ┌────┐  ┌────┐                       │
│  │ 🏆 │  │ 🎭 │  │ 🔨 │                       │
│  │Rare│  │Epic│  │Com │                       │
│  └────┘  └────┘  └────┘                       │
│  글쟁이   이야기꾼  건설                        │
│  III     II       노동자                       │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 업적 달성 토스트 (팝업 알림)

```
┌──────────────────────────────┐
│  🏆 업적 달성!               │
│  "글쟁이 III"                │
│  게시글 100개 작성           │
│  보상: 500P + 목재 3개       │
└──────────────────────────────┘
```

---

## 업적 트리거 삽입 지점

### 기존 코드에 훅 추가

| 파일 | 위치 | 트리거 |
|------|------|--------|
| `bbs/write_update.php` | 글 저장 후 (~line 321) | `mg_trigger_achievement($mb_id, 'write')` |
| `bbs/write_update.php` | 댓글 저장 후 (~line 325) | `mg_trigger_achievement($mb_id, 'comment')` |
| `bbs/rp_reply.php` | 이음 저장 후 (~line 41) | `mg_trigger_achievement($mb_id, 'rp_reply')` |
| `bbs/attendance_play.php` | 출석 완료 후 | `mg_trigger_achievement($mb_id, 'attendance')` |
| `bbs/shop_buy.php` | 구매 완료 후 | `mg_trigger_achievement($mb_id, 'shop_buy')` |
| `bbs/pioneer_contribute.php` | 시설 기여 후 | `mg_trigger_achievement($mb_id, 'pioneer')` |
| `plugin/morgan/morgan.php` | 시설 완공 시 | `mg_trigger_achievement($mb_id, 'facility_complete')` |

### 트리거 함수 동작 (개괄)

```php
function mg_trigger_achievement($mb_id, $event_type) {
    // 1. 해당 event_type에 관련된 업적 목록 조회
    // 2. 각 업적에 대해 현재 진행도 갱신
    //    - write_count → SELECT COUNT(*) FROM g5_write_...
    //    - rp_reply_count → SELECT COUNT(*) FROM mg_rp_reply WHERE ...
    //    - 또는 ua_progress를 +1 증가 (카운터 방식)
    // 3. 단계형: 다음 단계 target 도달 시 → 달성 처리, 보상 지급
    // 4. 일회성: 조건 충족 시 → 달성 처리, 보상 지급
    // 5. 알림 발송 (mg_notify)
}
```

> 성능 최적화: 모든 업적을 매번 체크하지 않고, event_type에 해당하는 업적만 필터링.
> 진행도는 캐시 가능 (ua_progress 컬럼에 저장, 매번 COUNT 쿼리 안 함).

---

## 개척 시스템 연동

### 시설 완공 시 업적 확정 흐름

```
시설 완공
    ↓
기여 랭킹 산출 (노동력/재료별 TOP 3)
    ↓
mg_facility_honor에 기록
    ↓
해당 유저들에게 업적 부여:
  - 1위: "건축왕" 업적 (해당 시설)
  - TOP 3: "건설 공로자" 업적
  - 참여자 전원: "개척자" 업적 진행도 +1
    ↓
업적 달성 알림 + 보상 지급
```

### 기여 행위 자체도 업적 진행

```
노동력 투입 → "건설 노동자" 업적 진행도 +투입량
재료 투입 → "자재왕" 업적 진행도 +투입량
첫 기여 → "초석" 일회성 업적 달성
```

---

## 관리자 기능

- 업적 등록/수정/삭제 (이름, 설명, 아이콘, 조건 JSON, 보상 JSON)
- 단계형 업적의 단계 관리 (단계 추가/수정/삭제)
- 카테고리 관리
- 유저에게 업적 수동 부여/회수
- 달성 통계 (업적별 달성률, 가장 많이 달성된 업적 등)
- 업적 활성화/비활성화

---

## 프론트 페이지 구성

### 신규 페이지

| 파일 | 역할 |
|------|------|
| `bbs/achievement.php` | 업적 목록 (카테고리 탭, 진행도 표시) |
| `bbs/achievement_display.php` | 프로필 쇼케이스 설정 (AJAX) |
| `theme/morgan/skin/achievement/` | 업적 관련 스킨 |

### 기존 페이지 수정

| 파일 | 수정 내용 |
|------|----------|
| `bbs/character_view.php` | 프로필에 업적 쇼케이스 표시 |
| `theme/morgan/head.php` | 업적 달성 토스트 알림 (JS) |
| `adm/admin.menu800.php` | 업적 관리 메뉴 추가 |

---

## 확장성

- 시즌 업적: 기간 한정 업적 (이벤트 연동)
- 숨겨진 업적: 조건이 `???`로 표시되는 서프라이즈 업적
- 업적 포인트: 각 업적에 점수를 부여하여 총 업적 점수 랭킹
- 길드/팩션 업적: 소속 그룹 단위 달성 (추후 길드 시스템 도입 시)
- 업적 기반 접근 제한: 특정 업적 달성자만 입장 가능한 게시판/기능
