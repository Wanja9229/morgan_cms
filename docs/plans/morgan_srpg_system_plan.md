# Morgan CMS — SRPG 전투 시스템 기획서

## 1. 개요

그리드 기반 턴제 Co-op PvE 전투 시스템.  
유저들이 파티를 구성하여 보스 몬스터에 도전하는 SRPG 방식의 전투 콘텐츠.

- **장르**: 택티컬 RPG (SRPG)
- **전투 형태**: Co-op PvE (파티 vs 보스)
- **조작 방식**: 턴제, 실시간 동기화
- **레퍼런스**: 파이어 엠블렘, FFT, 디스가이아 (높이 개념 제외)
- **비주얼 수준**: SS엔진과 동급 (DOM/CSS 기반)
- **예상 작업량**: SS엔진 대비 약 1.5~2배

---

## 2. 시스템 아키텍처

```
[유저 프론트 (DOM/CSS 그리드)]
    │
    ▼ 행동 선택 (이동/스킬/대기)
    │
[PHP API — 게임 로직 서버]
    │
    ├─ 유효성 검증 (이동 가능 범위, 스킬 사거리, 턴 소유권)
    ├─ 데미지 계산 (공식 기반)
    ├─ 보스 AI 행동 결정 (랜덤 풀 + 페이즈)
    ├─ 턴 순서 관리
    └─ 승리/패배 판정
    │
    ▼ 결과 상태 업데이트
    │
[Supabase Realtime — 웹소켓 브로드캐스트]
    │
    ▼ 모든 참여자에게 상태 동기화
    │
[각 유저 프론트 — 결과 연출 반영]
```

### 핵심 원칙
- **서버 권위**: 모든 판정은 PHP에서 처리. 프론트는 연출만 담당
- **PHP**: 게임 로직 전담 (데미지, 이동, 턴, 승패)
- **Supabase**: 실시간 상태 동기화만 담당 (웹소켓)
- **프론트**: DOM/CSS 그리드 렌더링 + 애니메이션

---

## 3. 그리드 맵

### 3-1. 기본 사양

| 항목 | 값 |
|------|-----|
| 기본 맵 크기 | 15 × 15 |
| 맵 크기 | 관리자 커스텀 가능 |
| 렌더링 방식 | DOM/CSS Grid |
| 이펙트 확장 | 필요 시 Canvas 오버레이 레이어 추가 |

### 3-2. 타일 타입

관리자가 맵 에디터에서 타일을 배치하여 스테이지를 구성.

| 타일 타입 | 효과 | 비고 |
|----------|------|------|
| **일반** | 없음 | 기본 타일 |
| **이동불가** | 진입 불가 | 벽, 바위, 물 등 |
| **함정** | 진입 시 데미지 | 데미지량 설정 가능 |
| **디버프** | 진입 시 상태이상 부여 | 독, 슬로우 등 |
| **버프** | 진입 시 스탯 상승 | 공격력↑, 방어력↑ 등 |
| **회복** | 진입 시 HP 회복 | 회복량 설정 가능 |

### 3-3. 맵 에디터 (관리자)

- 그리드 크기 설정 (가로 × 세로)
- 타일 타입 선택 후 클릭/드래그로 배치
- 보스 초기 위치 지정
- 파티 시작 위치 영역 지정
- 커스텀 타일 이미지 업로드 가능 (관리자가 디자인한 타일 적용)
- 스테이지별 저장/불러오기

---

## 4. 파티 구성

| 항목 | 값 |
|------|-----|
| 최소 인원 | 2명 (솔로 노가다 방지) |
| 최대 인원 | 5명 (관리자 설정 가능) |
| 조작 단위 | 유저 1명 = 캐릭터 1명 조작 |

### 파티 플로우

```
파티장이 전투 스테이지 선택
    → 파티원 모집 (대기실)
    → 인원 충족 시 파티장이 "전투 시작"
    → 맵 로드 + 시작 위치 배치
    → 전투 개시
```

---

## 5. 스탯 시스템

### 5-1. 전투 전용 스탯 (SRPG용 별도 스탯)

기존 Morgan 캐릭터 스탯과는 별개로 SRPG 전투 전용 스탯을 운용.

| 스탯 | 약자 | 역할 |
|------|------|------|
| HP | HP | 체력. 0이 되면 전투불능 |
| MP | MP | 스킬 사용 시 소모 |
| 공격력 | ATK | 물리 데미지 기본값 |
| 방어력 | DEF | 물리 피해 감소 |
| 마력 | MAG | 마법 데미지 기본값 |
| 마방 | RES | 마법 피해 감소 |
| 민첩 | SPD | 턴 순서 결정 |
| 이동력 | MOV | 턴당 이동 가능 그리드 수 |

### 5-2. 스탯 성장

- 관리자가 레벨별 성장 테이블 설정
- 또는 전투 보상으로 스탯 포인트 획득 → 자유 분배

---

## 6. 스킬 시스템

### 6-1. 스킬 슬롯

| 구분 | 슬롯 수 | 획득 방법 |
|------|---------|----------|
| 기본 | 2개 | 캐릭터 생성 시 |
| 추가 1 | 1개 | 연구(기술트리)로 해금 |
| 추가 2 | 1개 | 상점 고가 아이템 구매 |
| **합계** | **최대 4개** | |

### 6-2. 스킬 등록 (관리자)

관리자가 스킬을 생성할 때 설정하는 항목:

| 항목 | 설명 |
|------|------|
| 스킬명 | 표시 이름 |
| 타입 | 물리 / 마법 |
| MP 소모 | 사용 시 소모되는 MP |
| 사거리 | 시전 가능 거리 (그리드 수) |
| 범위 형태 | 단일 / 십자 / 직선 / 정사각 / 다이아몬드 등 |
| 범위 크기 | 영향 범위 (그리드 수) |
| 데미지 공식 | 예: `ATK * 1.5 - target.DEF * 0.5` |
| 추가 효과 | 상태이상 부여, 버프, 회복 등 (선택) |
| 쿨타임 | 재사용 대기 턴 수 (0이면 매턴 사용 가능) |

### 6-3. 범위 형태 예시 (15x15 기준, ★ = 시전자, ■ = 영향 범위)

**단일 (사거리 3)**
```
· · · · ·
· · ■ · ·
· · · · ·
· · ★ · ·
```

**십자 (범위 1)**
```
· · ■ · ·
· ■ ■ ■ ·
· · ■ · ·
```

**정사각 (범위 1 = 3x3)**
```
■ ■ ■
■ ■ ■
■ ■ ■
```

**다이아몬드 (범위 2)**
```
· · ■ · ·
· ■ ■ ■ ·
■ ■ ■ ■ ■
· ■ ■ ■ ·
· · ■ · ·
```

---

## 7. 턴 시스템

### 7-1. 턴 순서

- 민첩(SPD) 스탯 기준 내림차순으로 행동 순서 결정
- 보스도 SPD 기반으로 턴 순서에 포함
- 동일 SPD인 경우 랜덤으로 결정

### 7-2. 턴 제한 시간

- **1~3분** (관리자 설정 가능)
- 제한 시간 초과 시 → 자동 대기 (턴 스킵) 처리
- 타이머는 모든 참여자 화면에 실시간 표시

### 7-3. 턴 내 행동

한 턴에 수행 가능한 행동:

| 행동 | 설명 |
|------|------|
| **이동** | MOV 범위 내 그리드 이동 (1회) |
| **스킬 사용** | 사거리 내 대상에게 스킬 시전 (1회) |
| **대기** | 아무것도 하지 않고 턴 종료 |

- 이동 → 스킬 순서로 수행 가능 (이동 후 공격)
- 스킬 → 이동은 불가 (행동 후 이동 허용 여부는 관리자 설정)
- 이동만 하고 턴 종료 가능
- 스킬만 쓰고 턴 종료 가능

---

## 8. 보스 몬스터 시스템

### 8-1. 보스 등록 (관리자)

**몬스터 기본 정보:**

| 항목 | 설명 |
|------|------|
| 이름 | 보스 표시명 |
| 이미지 | 보스 스프라이트 (관리자 업로드) |
| HP | 총 체력 |
| 스탯 | ATK, DEF, MAG, RES, SPD |
| 크기 | 차지하는 그리드 수 (1x1, 2x2, 3x3 등) |
| 페이즈 구분 | HP 구간별 페이즈 전환 기준 |

### 8-2. 행동 패턴 등록

**행동(Action) 등록 → 몬스터에 묶기 방식**

#### Step 1: 행동 개별 등록

| 항목 | 설명 |
|------|------|
| 행동명 | 예: "화염 브레스", "꼬리 휩쓸기" |
| 타겟 방식 | 단일 대상(랜덤/최근접/최저HP) / 범위 지정 |
| 범위 형태 | 단일 / 십자 / 직선 / 정사각 / 다이아몬드 |
| 범위 크기 | 영향 그리드 수 |
| 데미지 공식 | 예: `ATK * 2.0 - target.DEF * 0.3` |
| 추가 효과 | 상태이상, 넉백, 디버프 등 (선택) |
| **전조 텍스트** | 1턴 전에 표시될 경고 문구 |
| 전조 범위 표시 | 전조 시 타일 위에 위험 영역 하이라이트 여부 |

#### Step 2: 몬스터에 행동 묶기 (페이즈별)

```
보스: "고대 드래곤"
│
├─ 페이즈 1 (HP 100%~51%)
│   ├─ 화염 브레스 (가중치: 3)
│   ├─ 꼬리 휩쓸기 (가중치: 5)
│   └─ 발톱 공격 (가중치: 4)
│
├─ 페이즈 2 (HP 50%~21%)
│   ├─ 화염 브레스+ (가중치: 4)
│   ├─ 꼬리 휩쓸기 (가중치: 3)
│   ├─ 메테오 (가중치: 2)
│   └─ 포효 [전체 디버프] (가중치: 3)
│
└─ 페이즈 3 (HP 20%~0%)
    ├─ 메테오+ (가중치: 5)
    ├─ 멸살의 브레스 (가중치: 3)
    └─ 자폭 준비 [3턴 카운트다운] (가중치: 1)
```

- **가중치**: 행동 선택 확률. 가중치 높을수록 자주 사용
- 매 턴 해당 페이즈의 행동 풀에서 가중치 기반 랜덤으로 다음 행동 선택
- 선택된 행동의 **전조 텍스트**가 현재 턴에 표시 → 다음 보스 턴에 실행

### 8-3. 보스 턴 플로우

```
[보스 턴 시작]
    │
    ├─ 전조된 행동이 있으면 → 실행 (데미지/효과 처리)
    │
    ├─ 현재 HP로 페이즈 확인
    │
    ├─ 해당 페이즈 행동 풀에서 가중치 랜덤으로 다음 행동 선택
    │
    ├─ 선택된 행동의 전조 텍스트 + 위험 범위 표시
    │
    └─ 턴 종료 → 다음 유저 턴으로
```

**전조 표현:**
- 화면 상단 또는 보스 말풍선으로 전조 텍스트 표시
- 타일 위에 위험 범위 하이라이트 (빨간색 반투명 오버레이)
- 유저는 1턴 동안 회피/방어 준비 가능

---

## 9. 전투 플로우 전체

```
[1] 파티장이 스테이지 선택 + 파티원 모집
[2] 인원 충족 → 파티장이 "전투 시작"
[3] 맵 로드, 캐릭터 시작 위치 배치
[4] SPD 기준으로 전체 턴 순서 결정 (유저 + 보스 포함)
[5] 전투 루프 시작:
    │
    ├─ [유저 턴]
    │   ├─ 이동 범위 하이라이트
    │   ├─ 유저가 이동/스킬/대기 선택
    │   ├─ PHP에서 판정 처리
    │   ├─ Supabase로 결과 브로드캐스트
    │   ├─ 모든 프론트에 연출 반영
    │   └─ 타임아웃 시 자동 대기
    │
    ├─ [보스 턴]
    │   ├─ 전조된 행동 실행
    │   ├─ 다음 행동 랜덤 선택 + 전조 표시
    │   ├─ 결과 브로드캐스트
    │   └─ 모든 프론트에 연출 반영
    │
    └─ 반복
[6] 종료 조건:
    ├─ 보스 HP 0 → 승리 (보상 지급)
    └─ 파티 전원 HP 0 → 패배
```

---

## 10. 프론트 구현 방향

### DOM/CSS 기반

| 요소 | 구현 방식 |
|------|----------|
| 그리드 맵 | CSS Grid (15x15) |
| 타일 하이라이트 | CSS 클래스 토글 (이동 범위: 파랑, 스킬 범위: 초록, 위험 범위: 빨강) |
| 캐릭터/보스 | 타일 위 absolute 배치, 이미지 표시 |
| 이동 애니메이션 | CSS transition (transform) |
| 데미지 표시 | 숫자 팝업 (CSS animation, fadeUp) |
| 피격 연출 | CSS shake animation |
| 전조 표시 | 타일 오버레이 (빨간 반투명) + 텍스트 말풍선 |
| 턴 순서 UI | 사이드바 또는 상단에 초상화 순서 표시 |
| 타이머 | 진행 바 또는 카운트다운 숫자 |

### 확장 시

- 스킬 이펙트 등 화려한 연출이 필요하면 Canvas 레이어를 그리드 위에 오버레이
- 그리드 자체는 DOM 유지, 이펙트만 Canvas 처리

---

## 11. DB 구조 (개략)

### 스테이지 관련
- `srpg_stages` — 스테이지 정보 (이름, 맵 크기, 보상 등)
- `srpg_stage_tiles` — 스테이지별 타일 배치 (x, y, tile_type)
- `srpg_stage_spawns` — 시작 위치 + 보스 위치

### 몬스터 관련
- `srpg_monsters` — 몬스터 기본 정보 (이름, 스탯, 크기, 이미지)
- `srpg_monster_phases` — 페이즈 정보 (HP 구간)
- `srpg_actions` — 행동 개별 등록 (이름, 범위, 데미지 공식, 전조 텍스트)
- `srpg_monster_phase_actions` — 페이즈별 행동 매핑 (가중치 포함)

### 캐릭터 전투 관련
- `srpg_char_stats` — 캐릭터별 SRPG 전용 스탯
- `srpg_skills` — 스킬 정보 (사거리, 범위, 공식 등)
- `srpg_char_skills` — 캐릭터별 장착 스킬 (최대 4슬롯)

### 전투 세션 관련
- `srpg_battles` — 전투 세션 (스테이지, 상태, 생성시간)
- `srpg_battle_members` — 참여 캐릭터 목록
- `srpg_battle_state` — 실시간 전투 상태 (현재 턴, 캐릭터 위치, HP 등)
- `srpg_battle_log` — 행동 로그 (리플레이/디버깅용)

---

## 12. 관리자 기능 요약

| 기능 | 설명 |
|------|------|
| **맵 에디터** | 그리드 크기 설정, 타일 배치, 스폰 위치 지정, 커스텀 타일 업로드 |
| **몬스터 관리** | 몬스터 생성, 스탯 설정, 이미지 업로드, 크기 설정 |
| **행동 관리** | 행동 개별 생성 (범위, 공식, 전조 텍스트) |
| **페이즈 구성** | 몬스터에 행동 묶기, HP 구간별 페이즈 설정, 가중치 조정 |
| **스킬 관리** | 유저용 스킬 생성 (사거리, 범위, 공식, 추가효과) |
| **스탯 설정** | 레벨별 성장 테이블 또는 포인트 분배 방식 설정 |
| **전투 설정** | 최대 파티 인원, 턴 제한시간, 행동 후 이동 허용 여부 등 |

---

## 13. 향후 확장 가능성

| 확장 | 설명 |
|------|------|
| **PvP 아레나** | 유저 vs 유저 대전. 동일 그리드 시스템 활용 |
| **이벤트 던전** | 기간 한정 스테이지, 랭킹 보상 |
| **장비 시스템** | 무기/방어구로 스탯 보정 |
| **상태이상 체계** | 독, 화상, 빙결, 스턴, 침묵 등 |
| **Canvas 이펙트** | 스킬 발동 시 화려한 파티클 연출 |
| **리플레이** | battle_log 기반 전투 재생 기능 |
| **점령전 연동** | 세력전 결전을 SRPG 방식으로 해소 (선택적) |

---

## 14. 참고

- 본 시스템은 Morgan CMS의 2차 개발 항목으로 분류
- SS엔진 대비 약 1.5~2배 작업량 예상
- 프론트: DOM/CSS 기반, 필요 시 Canvas 이펙트 레이어 확장
- 서버: PHP 로직 + Supabase Realtime 동기화
