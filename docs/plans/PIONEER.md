# Phase 8: 개척 시스템 (Pioneer / Construction System)

## 기획 의도

커뮤니티의 콘텐츠와 기능을 처음부터 전부 열어두지 않는다.
유저들이 **매일 부여받는 노동력**과 **활동으로 얻는 건축 재료**를 공동으로 투입하여 **시설을 건설**하면,
해당 시설에 연결된 기능이 해금되는 구조.

이를 통해:
- 유저에게 **매일 접속할 이유**를 제공한다 (노동력 일일 리셋)
- **커뮤니티 협동 목표**를 만들어 유저 간 소통과 결속을 유도한다 (유저란 토의 → 건설 순서 결정)
- 재화 싱크로서 **포인트/재료의 소비처**를 확보한다 (상점에서 재료 구매)
- 시설 해금이라는 **장기 목표**로 유저 리텐션을 강화한다
- 기여도 랭킹으로 **경쟁과 명예**를 부여한다

---

## 핵심 개념

### 노동력 (Stamina / Labor)

- 매일 고정량(기본 10)이 지급되는 일일 재화
- 자정 기준 리셋 (cron 불필요, 접속 시 날짜 비교로 패시브 리셋)
- 시설 건설에 투입하여 소모
- 추후 특정 시설 해금으로 일일 노동력 상한 증가 가능

### 건축 재료 (Materials)

- 활동(글 작성, 댓글, RP 이음, 출석 등)으로 획득
- 상점에서 포인트로 구매 가능 (재화 싱크)
- 종류 예시: 목재, 석재, 철광석, 책, 유리, 마법석 등
- 재료 종류는 관리자가 자유롭게 추가/관리

### 시설 (Facility)

- 건설 비용: 노동력 + 재료 N종 (시설마다 다름)
- 상태: `locked` → `building` → `complete`
- 완공 시 연결된 기능이 해금됨
- **모든 유저의 기여가 합산**되어 공동 건설

### 기여와 랭킹

- 시설별 기여 기록: 누가, 무엇을(노동력/재료별), 얼마나 투입했는지
- 시설 완공 시 노동력/재료 종류별 기여 1~3위 확정
- 명예의 전당 또는 해당 시설 페이지에 상위 기여자 표시
- 업적 시스템과 연동 (기여 1위 → 특수 업적)

---

## 시설 해금 매핑 (예시)

| 시설 | 비용 (예시) | 해금 기능 |
|------|------------|----------|
| 게시판 관리소 | 노동력 500 + 목재 5 | 자유게시판, 갤러리 등 기본 게시판 |
| 알림판 | 노동력 300 + 목재 3 | 앓이란 (감정 게시판) |
| 극장 | 노동력 2000 + 목재 15 + 유리 10 | 역극 시스템 |
| 도서관 | 노동력 3000 + 목재 10 + 석재 20 + 책 30 | 연혁/아카이빙 시스템 |
| 시장 확장 | 노동력 1500 + 석재 10 + 철광석 5 | 상점 카테고리 해금 (초기엔 재료만 구매 가능) |
| 창고 | 노동력 1000 + 목재 8 | 인벤토리 슬롯 확장 |
| 분수대 | 노동력 2000 + 석재 15 + 마법석 5 | 스탯 재분배 기능 |
| 영사기 | 노동력 2500 + 유리 20 + 마법석 10 | VN 엔진 / SS 엔진 |
| 공방 | 노동력 1500 + 철광석 10 | 이모티콘 제작 기능 해금 |

> 시설 목록, 비용, 해금 기능은 관리자가 자유롭게 설정 가능하도록 구현.
> 위 표는 기획 의도를 보여주는 예시일 뿐이며, 실제 값은 운영 시 조정.

---

## 게임루프

```
[매일 접속]
    ↓
노동력 10 지급
    ↓
[활동] 글 작성 / 댓글 / RP / 출석 → 재료 획득
    ↓
[상점] 포인트로 부족한 재료 구매 (재화 싱크)
    ↓
[유저란 토의] "다음엔 도서관을 짓자!" → 커뮤니티 합의
    ↓
[시설 건설 페이지] 노동력 + 재료 투입 → 진행률 상승
    ↓
[완공] 기능 해금 + 기여 랭킹 확정 + 업적 트리거
    ↓
[명예의 전당] 상위 기여자 기록 영구 보존
    ↓
[다음 시설 선택] → 루프 반복
```

---

## DB 스키마 (개괄)

### mg_material_type - 재료 종류 정의

| 컬럼 | 타입 | 설명 |
|------|------|------|
| mt_id | int PK | 재료 ID |
| mt_name | varchar(50) | 재료 이름 (목재, 석재...) |
| mt_code | varchar(30) | 코드 (wood, stone...) |
| mt_icon | varchar(200) | 아이콘 이미지/이모지 |
| mt_desc | varchar(200) | 설명 |
| mt_order | int | 정렬 순서 |

### mg_user_material - 유저별 재료 보유량

| 컬럼 | 타입 | 설명 |
|------|------|------|
| um_id | int PK | |
| mb_id | varchar(20) | 회원 ID |
| mt_id | int | 재료 종류 |
| um_count | int | 보유 수량 |
| UNIQUE | (mb_id, mt_id) | |

### mg_user_stamina - 유저별 노동력

| 컬럼 | 타입 | 설명 |
|------|------|------|
| us_id | int PK | |
| mb_id | varchar(20) UNIQUE | 회원 ID |
| us_current | int | 현재 노동력 |
| us_max | int | 일일 최대 (기본 10) |
| us_last_reset | date | 마지막 리셋 날짜 |

> 리셋 로직: `us_last_reset < TODAY`이면 `us_current = us_max`으로 리셋, `us_last_reset = TODAY` 갱신.
> 출석체크와 동일한 패시브 리셋 방식. cron 불필요.

### mg_facility - 시설 정의

| 컬럼 | 타입 | 설명 |
|------|------|------|
| fc_id | int PK | 시설 ID |
| fc_name | varchar(100) | 시설 이름 |
| fc_desc | text | 설명 |
| fc_image | varchar(500) | 시설 이미지 |
| fc_icon | varchar(100) | 아이콘 |
| fc_status | enum | `locked`, `building`, `complete` |
| fc_unlock_key | varchar(100) | 해금할 mg_config 키 |
| fc_unlock_value | varchar(100) | 해금 시 설정할 값 |
| fc_stamina_cost | int | 필요 총 노동력 |
| fc_stamina_current | int | 현재 투입된 노동력 |
| fc_order | int | 표시 순서 |
| fc_complete_date | datetime NULL | 완공일 |

### mg_facility_material_cost - 시설별 필요 재료

| 컬럼 | 타입 | 설명 |
|------|------|------|
| fmc_id | int PK | |
| fc_id | int | 시설 ID |
| mt_id | int | 재료 종류 |
| fmc_required | int | 필요 수량 |
| fmc_current | int | 현재 투입된 수량 |

### mg_facility_contribution - 기여 기록

| 컬럼 | 타입 | 설명 |
|------|------|------|
| fcn_id | int PK | |
| fc_id | int | 시설 ID |
| mb_id | varchar(20) | 회원 ID |
| fcn_type | enum | `stamina`, `material` |
| mt_id | int NULL | 재료 종류 (type=material일 때) |
| fcn_amount | int | 투입량 |
| fcn_datetime | datetime | 투입 시각 |

> 기여 랭킹 산출: `GROUP BY mb_id, fcn_type, mt_id` → `SUM(fcn_amount)` → `ORDER BY SUM DESC LIMIT 3`

### mg_facility_honor - 명예의 전당 (완공 후 확정)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| fh_id | int PK | |
| fc_id | int | 시설 ID |
| fh_rank | int | 순위 (1, 2, 3) |
| fh_category | varchar(30) | 카테고리 (stamina, wood, stone...) |
| mb_id | varchar(20) | 회원 ID |
| fh_amount | int | 총 기여량 |

---

## 재료 획득 경로

| 활동 | 보상 (예시) |
|------|------------|
| 글 작성 | 목재 1 |
| 댓글 작성 | 랜덤 재료 1 (낮은 확률) |
| RP 이음 | 석재 1 또는 책 1 |
| 출석체크 | 랜덤 재료 1~2 |
| 연속 출석 7일 | 보너스 재료 묶음 |
| 상점 구매 | 포인트로 원하는 재료 직접 구매 |

> 활동별 보상은 관리자 설정으로 조정 가능하도록 구현.
> `mg_config`로 글로벌 설정, 또는 별도 보상 테이블로 세밀한 제어.

---

## 상점 연동

### 초기 상태
- 상점은 **재료 카테고리만** 열려 있음
- 기본 재료(목재, 석재 등)만 구매 가능

### 시장 확장 시설 건설 시
- 칭호/뱃지/닉네임 효과 등 기존 상점 아이템 카테고리 순차 해금
- 시설 단계별로 카테고리가 열리는 구조
  - 시장 1단계: 재료 + 소모품
  - 시장 2단계: 칭호/뱃지
  - 시장 3단계: 닉네임 효과/프로필 테두리
  - ...

### 인벤토리 슬롯 제한
- 초기 인벤토리 슬롯: 기본 20칸 (mg_config)
- 창고 시설 건설 → 슬롯 상한 증가 (30 → 40 → ...)
- 유저별 확장은 `mg_user_inventory_slots` 테이블 또는 mg_config 전역 값

---

## 프론트 페이지 구성

### 개척 현황 페이지 (`bbs/pioneer.php`)
- 전체 시설 목록 (카드 그리드)
- 각 시설: 이미지, 이름, 상태, 진행률 바, 필요/현재 자원
- 완공된 시설: 완공 배지 + 기여 TOP 3 표시
- 현재 건설중인 시설 강조

### 시설 상세/투입 페이지
- 시설 정보 + 해금 기능 설명
- 필요 자원 목록 (진행률 바 포함)
- "노동력 투입" 버튼 + "재료 투입" UI
- 기여 랭킹 (현재 진행 중이면 실시간, 완공되면 확정)
- 완공 축하 연출 (완공 시)

### 명예의 전당 페이지 (또는 시설 페이지 내 섹션)
- 완공된 시설별 기여 TOP 3
- 카테고리별 (노동력, 재료 종류별) 순위
- 업적 시스템과 연결

### 사이드바
- 현재 노동력 표시 (아이콘 + 잔여량/최대량)
- 클릭 시 개척 현황 페이지로 이동

---

## 관리자 기능

- 재료 종류 관리 (추가/수정/삭제)
- 시설 등록/수정/삭제 (비용 설정, 해금 기능 매핑)
- 시설 상태 강제 변경 (locked → building → complete)
- 활동별 재료 보상 설정
- 노동력 기본값/상한 설정
- 유저별 재료/노동력 수동 지급

---

## 구현 연동 포인트

### 기존 코드 수정 위치

| 파일 | 수정 내용 |
|------|----------|
| `plugin/morgan/morgan.php` | 테이블 등록, 노동력/재료 헬퍼 함수, 시설 진행/완공 로직 |
| `plugin/morgan/install/install.sql` | 신규 테이블 6개 + config 기본값 |
| `bbs/write_update.php` (line ~321) | 글 작성 후 재료 지급 훅 |
| `bbs/rp_reply.php` (line ~41) | RP 이음 후 재료 지급 훅 |
| `bbs/attendance_play.php` | 출석 후 재료 지급 훅 |
| `theme/morgan/head.php` | 사이드바 노동력 표시 + 개척 링크 |
| `bbs/shop.php` / shop.skin.php | 상점 카테고리 해금 상태 체크 |
| `bbs/inventory.php` | 슬롯 제한 적용 |

### 신규 파일

| 파일 | 역할 |
|------|------|
| `bbs/pioneer.php` | 개척 현황 페이지 |
| `bbs/pioneer_contribute.php` | 자원 투입 처리 (AJAX) |
| `theme/morgan/skin/pioneer/` | 개척 관련 스킨 |
| `adm/morgan/pioneer_facility.php` | 시설 관리 |
| `adm/morgan/pioneer_material.php` | 재료 관리 |

---

## 확장성

- 시설 "연구소" → 새로운 재료 종류 해금
- 시설 "우체국" → 쪽지/선물 시스템 해금
- 시설 "학교" → 튜토리얼/가이드 시스템 해금
- 시설 "성벽" → 시즌제 이벤트 해금
- 시설 단계 (1단계 → 2단계 업그레이드) 개념 추가 가능
- 특정 시설은 선행 시설 완공이 필요한 **테크트리** 구조도 가능
